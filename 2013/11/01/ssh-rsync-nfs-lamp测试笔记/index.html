<!doctype html>
<html class="theme-next   use-motion ">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"/>




  <link href="//fonts.googleapis.com/css?family=Lato:300,400,700,400italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">



<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=0.4.5.2" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="linux,mysql,nfs,rsync,ssh," />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=0.4.5.2" />






<meta name="description" content="刚刚做了一次服务搭建模拟，然后形成了doc笔记，出于便捷性，感觉还是形成blog最好，so，就将doc转成了markdown了。这篇文章《ssh密钥分发_rsync同步_nfs_lamp服务搭建笔记》是比较简单的网站架构，感觉还是挺中肯的，实际应用还是要根据需求来决定的，这里就不分析了。
文章结构，如下：
1    总体架构图2    数据流说明3    生产环境搭建需求3.1    软件需求3.">
<meta property="og:type" content="article">
<meta property="og:title" content="ssh密钥分发_rsync同步_nfs_lamp服务搭建笔记">
<meta property="og:url" content="http://ifcheung2012.github.io/2013/11/01/ssh-rsync-nfs-lamp测试笔记/index.html">
<meta property="og:site_name" content="IF's blog">
<meta property="og:description" content="刚刚做了一次服务搭建模拟，然后形成了doc笔记，出于便捷性，感觉还是形成blog最好，so，就将doc转成了markdown了。这篇文章《ssh密钥分发_rsync同步_nfs_lamp服务搭建笔记》是比较简单的网站架构，感觉还是挺中肯的，实际应用还是要根据需求来决定的，这里就不分析了。
文章结构，如下：
1    总体架构图2    数据流说明3    生产环境搭建需求3.1    软件需求3.">
<meta property="og:image" content="http://gitimg.qiniudn.com/diary1_test_img_010.png">
<meta property="og:image" content="http://gitimg.qiniudn.com/diary1_test_img_003.png">
<meta property="og:image" content="http://gitimg.qiniudn.com/diary1_test_img_004.png">
<meta property="og:image" content="http://gitimg.qiniudn.com/diary1_test_img_005.png">
<meta property="og:image" content="http://gitimg.qiniudn.com/diary1_test_img_006.png">
<meta property="og:image" content="http://gitimg.qiniudn.com/diary1_test_img_007.png">
<meta property="og:image" content="http://gitimg.qiniudn.com/diary1_test_img_008.png">
<meta property="og:image" content="http://gitimg.qiniudn.com/diary1_test_img_009.png">
<meta property="og:updated_time" content="2015-11-18T09:57:52.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="ssh密钥分发_rsync同步_nfs_lamp服务搭建笔记">
<meta name="twitter:description" content="刚刚做了一次服务搭建模拟，然后形成了doc笔记，出于便捷性，感觉还是形成blog最好，so，就将doc转成了markdown了。这篇文章《ssh密钥分发_rsync同步_nfs_lamp服务搭建笔记》是比较简单的网站架构，感觉还是挺中肯的，实际应用还是要根据需求来决定的，这里就不分析了。
文章结构，如下：
1    总体架构图2    数据流说明3    生产环境搭建需求3.1    软件需求3.">



<script type="text/javascript" id="hexo.configuration">
  var CONFIG = {
    scheme: '',
    sidebar: 'post',
    motion: true
  };
</script>

  <title> ssh密钥分发_rsync同步_nfs_lamp服务搭建笔记 | IF's blog </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  <!--[if lte IE 8]>
  <div style=' clear: both; height: 59px; padding:0 0 0 15px; position: relative;margin:0 auto;'>
    <a href="http://windows.microsoft.com/en-US/internet-explorer/products/ie/home?ocid=ie6_countdown_bannercode">
      <img src="http://7u2nvr.com1.z0.glb.clouddn.com/picouterie.jpg" border="0" height="42" width="820"
           alt="You are using an outdated browser. For a faster, safer browsing experience, upgrade for free today or use other browser ,like chrome firefox safari."
           style='margin-left:auto;margin-right:auto;display: block;'/>
    </a>
  </div>
<![endif]-->
  






  <div class="container one-column page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">IF's blog</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle"></p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu ">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-home fa-fw"></i> <br />
            
            首頁
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-archive fa-fw"></i> <br />
            
            歸檔
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-tags fa-fw"></i> <br />
            
            標籤
          </a>
        </li>
      

      
      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div id="content" class="content">
          

  <div id="posts" class="posts-expand">
    

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                ssh密钥分发_rsync同步_nfs_lamp服务搭建笔记
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            發表於
            <time itemprop="dateCreated" datetime="2013-11-01T20:02:23+08:00" content="2013-11-01">
              2013-11-01
            </time>
          </span>

          

          
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        <span itemprop="articleBody"><p>刚刚做了一次服务搭建模拟，然后形成了doc笔记，出于便捷性，感觉还是形成blog最好，so，就将doc转成了markdown了。<br>这篇文章《ssh密钥分发_rsync同步_nfs_lamp服务搭建笔记》是比较简单的网站架构，感觉还是挺中肯的，实际应用还是<br>要根据需求来决定的，这里就不分析了。</p>
<h3 id="文章结构，如下：">文章结构，如下：</h3><blockquote>
<p>1    总体架构图<br>2    数据流说明<br>3    生产环境搭建需求<br>3.1    软件需求<br>3.2    IP地址需求<br>3.3    服务器需求<br>3.4    架构需求<br>4    涉及到的技术<br>5    总结架构中的优缺点<br>6   详细搭建过程</p>
</blockquote>
<p>总的来讲，好记性不如烂笔头，还是记下为妙，任何时候，还是要参看文档，而非经验！<br>好了！不多说了，‘冻’手了…<br><a id="more"></a></p>
<h2 id="总体架构图">总体架构图</h2><p><img src="http://gitimg.qiniudn.com/diary1_test_img_010.png" alt="总体架构图"></p>
<h2 id="数据流说明">数据流说明</h2><p>1、用户通过internet访问到web服务器www.zif.com/bbs.zif.com/blog.zif.com域名；<br>2、用户更新帖子、发布博客等，将数据写入到数据库（注意，数据库和web服务器是分离的）；<br>3、用户上传图片，将通过web服务器把数据上传到NFS存储上，而不保留在web服务器本地；<br>4、所有的数据最终都备份到备份服务器上留存；<br>5、NFS存储兼职分发服务器，会把需求分发的文件批量分发到其他网内节点服务器。</p>
<h2 id="生产环境搭建需求">生产环境搭建需求</h2><h3 id="软件需求">软件需求</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">LINUX	CENTOS <span class="number">5.8</span> <span class="number">32</span>BIT/<span class="number">64</span>BIT</span><br><span class="line">APACHE	<span class="number">2.2</span><span class="number">.22</span></span><br><span class="line">MYSQL	<span class="number">5.0</span>,<span class="number">5.1</span>,<span class="number">5.5</span></span><br><span class="line">PHP	<span class="number">5.3</span><span class="number">.10</span></span><br><span class="line">```   </span><br><span class="line"><span class="preprocessor">###	IP地址需求		</span></span><br><span class="line">说明：IP地址自行定义，最好分内外网卡，这样更接近实际环境。即办公室的<span class="number">10.0</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">24</span>网段作为外网IP，在添加一个<span class="number">10.0</span><span class="number">.1</span><span class="number">.0</span>/<span class="number">24</span>网段作为内网网段。web服务器有双IP，其他服务器仅有内网IP（<span class="number">10.0</span><span class="number">.1</span><span class="number">.0</span>/<span class="number">24</span>网段）。所有，内部网段通过web服务器上网（这个还没讲，可以不做）。</span><br><span class="line"><span class="preprocessor">###	服务器需求</span></span><br></pre></td></tr></table></figure>
<p>服务角色    服务器编号<br>WEB          A<br>MySQL     B<br>NFS          C<br>rsync     D<br>分发服务   C<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">说明：四台虚拟机</span><br><span class="line"></span><br><span class="line"><span class="preprocessor">###	架构需求</span></span><br><span class="line"></span><br><span class="line">&gt;<span class="number">1</span>、配置web服务器A，搭建LAMP环境，设置三个虚拟主机；</span><br><span class="line">&gt;<span class="number">2</span>、虚拟主机站点目录要求：  </span><br><span class="line">&gt;/data0/www/&#123;bbs,blog,www&#125;</span><br><span class="line"></span><br><span class="line">特别提示：web服务器上不需要跑数据库服务，数据在专门的数据库服务器上。</span><br><span class="line"></span><br><span class="line">&gt;<span class="number">3</span>、搭建专用数据库服务器B，存储web服务器上的CMS、bbs、blog动态数据；</span><br><span class="line">&gt;<span class="number">4</span>、搭建NFS共享存储服务器C，存储web服务器上的cms、bbs、blog资源数据，如图片、附件、头像等；</span><br><span class="line">注意NFS共享存储服务器只存放用户上传的资源数据。</span><br><span class="line"></span><br><span class="line">&gt;<span class="number">5</span>、需要搭建备份服务器D，用来备份WEB，数据库及NFS存储上的数据。</span><br><span class="line"><span class="number">6</span>、NFS存储服务器上有写入数据时，要实时将NFS上的图片，附件、头像等资源同步到rsync服务的热备服务器（当NFS存储宕机，可以手动切换，继续代替NFS提供服务）；</span><br><span class="line"><span class="number">7</span>、WEB服务器每天晚上<span class="number">00</span>点备份程序目录及访问日志并推送到备份服务器上（web服务器本地保留<span class="number">7</span>天数据，备份服务器保留<span class="number">3</span>个月数据副本）。</span><br><span class="line"><span class="number">8</span>、mysql服务器每天晚上<span class="number">00</span>：<span class="number">30</span>点备份数据库并推送到热备服务器（数据库本地保留<span class="number">7</span>天数据，备份服务器上保留<span class="number">3</span>个月数据副本）；</span><br><span class="line"><span class="number">9</span>、NFS存储C兼职分发服务器（也可单独搞），会把需要分发的文件批量分发到其他网内节点服务器，如A,B,D。</span><br><span class="line"><span class="number">10</span>、所有服务器配置定时时间同步，这里会遭遇到的问题，所有内网服务器（<span class="number">10.0</span><span class="number">.1</span><span class="number">.0</span>/<span class="number">24</span>）必须通过webserver上网，当然，你也可以配置NTP SERVER。</span><br><span class="line"></span><br><span class="line"><span class="preprocessor">##	本次部署涉及到的技术</span></span><br><span class="line">linux,apache,mysql,php,ssh,key,nfs,rsync,sersync,crontab,shell</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="preprocessor">##	模拟环境的搭建-VMWARE</span></span><br><span class="line">默认的vmnet8的IP地址太难看，想把ip段由<span class="number">192.168</span><span class="number">.115</span><span class="number">.0</span>改为<span class="number">192.168</span><span class="number">.0</span><span class="number">.0</span>,另外取消NAT DHCP的功能，自己分配静态IP地址；</span><br><span class="line"></span><br><span class="line">看过不少文章，说要配置为这样：</span><br><span class="line">![配置ip](http:<span class="comment">//gitimg.qiniudn.com/diary1_test_img_002.png)</span></span><br><span class="line">然后在虚拟机中设置静态IP地址：</span><br><span class="line"></span><br><span class="line">```shell</span><br><span class="line">[root@modepc ~]<span class="preprocessor"># cat /etc/sysconfig/network-scripts/ifcfg-eth0</span></span><br><span class="line"><span class="preprocessor"># Advanced Micro Devices [AMD] <span class="number">79</span>c970 [PCnet32 LANCE]</span></span><br><span class="line">DEVICE=eth0</span><br><span class="line">BOOTPROTO=<span class="keyword">static</span></span><br><span class="line">ONBOOT=yes</span><br><span class="line">HWADDR=<span class="number">00</span>:<span class="number">50</span>:<span class="number">56</span>:<span class="number">20</span>:<span class="number">42</span>:ef</span><br><span class="line">NETMASK=<span class="number">255.255</span><span class="number">.255</span><span class="number">.0</span></span><br><span class="line">IPADDR=<span class="number">192.168</span><span class="number">.0</span><span class="number">.11</span></span><br><span class="line">GATEWAY=<span class="number">192.168</span><span class="number">.0</span><span class="number">.2</span></span><br><span class="line">IPV6INIT=no</span><br><span class="line">[root@modepc ~]<span class="preprocessor">#</span></span><br></pre></td></tr></table></figure></p>
<p>重启网卡设置，ok了可以在静态地址下通过NAT上网并访问周边的机器了。<br>好了，那么问题来了，宿主机器无法ping通该虚拟机：<br><img src="http://gitimg.qiniudn.com/diary1_test_img_003.png" alt="图示"></p>
<blockquote>
<p>什么原因呢？<br>主要是上图中vmware network editor中的连接主机的选项没有勾选</p>
</blockquote>
<p><img src="http://gitimg.qiniudn.com/diary1_test_img_004.png" alt="配置VM"></p>
<blockquote>
<p>也就是说上图的选项表示宿主机与虚拟机的连接纽带，没有他宿主机器是无法直接连接该虚拟主机的，该选项也就是完全网络隔离虚拟主机至虚拟局域网内的一个重要选项。如果没有勾选该选项，在宿主机网络管理中关于vmnet8网卡的属性是这样的：</p>
</blockquote>
<p><img src="http://gitimg.qiniudn.com/diary1_test_img_005.png" alt="配置ip"></p>
<blockquote>
<p>如果勾选了上图中的选项，那么宿主机会自动调整该网卡的属性：</p>
</blockquote>
<p><img src="http://gitimg.qiniudn.com/diary1_test_img_006.png" alt="配置ip"></p>
<blockquote>
<p>注意：自己在测试的过程中发现，如果你没有通过勾选上图选项的方法来达到该图的效果，而是手工设置，那么你宿主的网络会发生冲突，具体原因不明（未深入），也就是说此时你的宿主网卡连不到外网了；</p>
</blockquote>
<p>好了，至此终于将node1配置成NAT下的一台静态IP服务器，那么他又如何连接到后端服务器，且后端服务器又如何拒绝包括宿主在内的其他机器的网络访问呢？那就很easy了，直接在Node1上添加一块网卡eth1，模式为host-only，模式里要将vmnet1的选项修改下，同eth0:去dhcp，并去与宿主机的直接连接，同时修改eth1的静态ip：<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@modepc ~]# vim /etc/sysconfig/network-scripts/ifcfg-eth1 &#10;# Advanced Micro Devices [AMD] 79c970 [PCnet32 LANCE]&#10;DEVICE=eth1&#10;BOOTPROTO=static&#10;ONBOOT=yes&#10;HWADDR=00:50:56:37:e6:14&#10;IPADDR=192.168.58.161&#10;NETMASK=255.255.255.0&#10;IPV6INIT=no</span><br></pre></td></tr></table></figure></p>
<p>那么按照本文的要求，如果每个内网服务器都仅能访问内网，且IP不同，那就得如下设置：</p>
<p><img src="http://gitimg.qiniudn.com/diary1_test_img_007.png" alt="ip拓扑"></p>
<p>但是显然，不需要这么多的交换机，形成了不必要的设备冗余，这里仅为了说明，vmnet的作用，按照本文的需要，实际上我们仅要使用vmnet1一台就够了，将内网服务器IP全部挂到该交换机下，这样保证了内网机器间的网络连通性，至于内网机器间的服务互访，在实际配置具体服务时配置。<br>那么最终的网络架构图，如下图：<br><img src="http://gitimg.qiniudn.com/diary1_test_img_008.png" alt="配置ip"><br>那么，到目前为止已经有了一台162的B机器，其他两台直接依次克隆即可（注意：克隆后修改MAC地址和主机名等）<br>最终的机器列表如下：<br><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">主机名	<span class="tag">ip</span>	<span class="tag">mac</span>地址	作用</span><br><span class="line"><span class="tag">node1</span>	192<span class="class">.168</span><span class="class">.58</span><span class="class">.161</span>	00<span class="pseudo">:50</span><span class="pseudo">:56</span><span class="pseudo">:20</span><span class="pseudo">:42</span><span class="pseudo">:EF</span>	<span class="tag">web</span> <span class="tag">server</span></span><br><span class="line"><span class="tag">node2</span>	192<span class="class">.168</span><span class="class">.58</span><span class="class">.162</span>	00<span class="pseudo">:50</span><span class="pseudo">:56</span><span class="pseudo">:22</span><span class="pseudo">:D1</span><span class="pseudo">:AC</span>	<span class="tag">database</span></span><br><span class="line"><span class="tag">node3</span>	192<span class="class">.168</span><span class="class">.58</span><span class="class">.163</span>	00<span class="pseudo">:50</span><span class="pseudo">:56</span><span class="pseudo">:2D</span><span class="pseudo">:11</span><span class="pseudo">:EA</span>	<span class="tag">NFS</span></span><br><span class="line"><span class="tag">node4</span>	192<span class="class">.168</span><span class="class">.58</span><span class="class">.164</span>	00<span class="pseudo">:50</span><span class="pseudo">:56</span><span class="pseudo">:31</span><span class="pseudo">:ED</span><span class="pseudo">:01</span>	<span class="tag">backup</span></span><br></pre></td></tr></table></figure></p>
<p>推荐好文：<a href="http://blog.csdn.net/wang_cir/article/details/6727416" target="_blank" rel="external">http://blog.csdn.net/wang_cir/article/details/6727416</a></p>
<h2 id="请思考本次架构中的优缺点">请思考本次架构中的优缺点</h2><p>数据库宕机了怎么办？只能重新搞一台，然后恢复过去</p>
<p>查看下系统配置<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@c2 torapp]<span class="preprocessor"># dmidecode | grep <span class="string">"Product"</span></span></span><br><span class="line">Product Name: VMware Virtual Platform</span><br><span class="line">Product Name: <span class="number">440</span>BX Desktop Reference Platform --一般会显示诸如dell r710 等厂商机器的具体品牌信息；</span><br><span class="line">[root@c2 torapp]<span class="preprocessor"># ifconfig eth0</span></span><br><span class="line">eth0      Link encap:Ethernet  HWaddr <span class="number">00</span>:<span class="number">50</span>:<span class="number">56</span>:<span class="number">24</span>:<span class="number">35</span>:<span class="number">51</span>  </span><br><span class="line">inet addr:<span class="number">192.168</span><span class="number">.115</span><span class="number">.132</span>  Bcast:<span class="number">192.168</span><span class="number">.115</span><span class="number">.255</span>  Mask:<span class="number">255.255</span><span class="number">.255</span><span class="number">.0</span></span><br><span class="line">inet6 addr: fe80::<span class="number">250</span>:<span class="number">56f</span>f:fe24:<span class="number">3551</span>/<span class="number">64</span> Scope:Link</span><br><span class="line">UP BROADCAST RUNNING MULTICAST  MTU:<span class="number">1500</span>  Metric:<span class="number">1</span></span><br><span class="line">RX packets:<span class="number">154078</span> errors:<span class="number">0</span> dropped:<span class="number">0</span> overruns:<span class="number">0</span> frame:<span class="number">0</span></span><br><span class="line">TX packets:<span class="number">97207</span> errors:<span class="number">0</span> dropped:<span class="number">0</span> overruns:<span class="number">0</span> carrier:<span class="number">0</span></span><br><span class="line">collisions:<span class="number">0</span> txqueuelen:<span class="number">1000</span> </span><br><span class="line">RX bytes:<span class="number">130778795</span> (<span class="number">124.7</span> MiB)  TX bytes:<span class="number">15622270</span> (<span class="number">14.8</span> MiB)</span><br><span class="line">Interrupt:<span class="number">19</span> Base address:<span class="number">0x2024</span> </span><br><span class="line"></span><br><span class="line">[root@c2 torapp]<span class="preprocessor">#</span></span><br></pre></td></tr></table></figure></p>
<h2 id="详细搭建过程">详细搭建过程</h2><h3 id="1_-_initial_os系统初始化脚本">1 - initial os系统初始化脚本</h3><figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line">. /etc/init.d/functions</span><br><span class="line"><span class="preprocessor">#config yum CentOS-Base.repo</span></span><br><span class="line">ConfigYum()&#123;</span><br><span class="line">echo <span class="string">"config yum centos-base.repo...."</span></span><br><span class="line">cd /etc/yum.repos.d/</span><br><span class="line">\cp CentOS-Base.repo CentOS-Base.repo.zif.$(date +%F)</span><br><span class="line">ping -c <span class="number">1</span> baidu.com &gt;/dev/<span class="literal">null</span></span><br><span class="line">[ ! $? -eq <span class="number">0</span> ] &amp;&amp; echo $<span class="string">"networking not configured - exiting...."</span> &amp;&amp; exit <span class="number">1</span></span><br><span class="line">wget --quiet -o /dev/<span class="literal">null</span> http:<span class="comment">//mirrors.sohu.com/help/CentOS-Base-sohu.repo</span></span><br><span class="line">\cp CentOS-Base-sohu.repo CentOS-Base.repo</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="preprocessor">#install chinese packages</span></span><br><span class="line"><span class="preprocessor">#yum -y install fonts-chinese fonts-ISO8859-2 &gt;/dev/null 2&gt;&amp;1</span></span><br><span class="line"></span><br><span class="line"><span class="preprocessor">#install init packages</span></span><br><span class="line">installTool()&#123;</span><br><span class="line">echo <span class="string">"sysstat ntp net-snmp lrzsz rsync"</span></span><br><span class="line">yum -y install sysstat ntp net-snmp lrzsz rsync &gt;/dev/<span class="literal">null</span> <span class="number">2</span>&gt;&amp;<span class="number">1</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="preprocessor">#charset GB18030</span></span><br><span class="line">initI18n()&#123;</span><br><span class="line">echo <span class="string">"#set LANG="</span>zh_cn.gb18030<span class="string">""</span></span><br><span class="line">\cp /etc/sysconfig/i18n /etc/sysconfig/i18n..$(date +%F)</span><br><span class="line">sed -i <span class="string">'s#LANG="en_US.UTF-8"#LANG="zh_CN.GB18030"#'</span> /etc/sysconfig/i18n</span><br><span class="line">source /etc/sysconfig/i18n</span><br><span class="line">grep<span class="constant"> LANG </span>/etc/sysconfig/i18n</span><br><span class="line">sleep <span class="number">1</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="preprocessor">#close selinux and iptables</span></span><br><span class="line">initfirewall()&#123;</span><br><span class="line">echo <span class="string">"#close selinux and iptables"</span></span><br><span class="line">cp /etc/selinux/config /etc/selinux/config.`date +<span class="string">"%Y-%m-%d_%H-%M-%S"</span>`</span><br><span class="line">/etc/init.d/iptables stop</span><br><span class="line">sed -i <span class="string">'s/SELINUX=enable/SELINUX=disabled/'</span> /etc/selinux/config</span><br><span class="line">setenforce <span class="number">0</span></span><br><span class="line">/etc/init.d/iptables status</span><br><span class="line">grep SELINUX=disabled /etc/selinux/config</span><br><span class="line">echo <span class="string">"close selinux-&gt;ok and iptables-&gt;ok"</span></span><br><span class="line">sleep <span class="number">1</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="preprocessor">#init auto startup service</span></span><br><span class="line">initService()&#123;</span><br><span class="line">echo <span class="string">"close nouseful service"</span></span><br><span class="line">export LANG=<span class="string">"en_US.UTF-8"</span></span><br><span class="line"><span class="keyword">for</span> zif in `chkconfig --list | grep <span class="number">3</span>:on |awk <span class="string">'&#123;print $1&#125;'</span>`;<span class="keyword">do</span> chkconfig --level <span class="number">3</span> zif ; done</span><br><span class="line"><span class="keyword">for</span> zif in crond network syslog sszif;<span class="keyword">do</span> chkconfig --level <span class="number">3</span> $zif on ; done</span><br><span class="line">export LANG=<span class="string">"zh_CN.GB18030"</span></span><br><span class="line">echo <span class="string">"close unuseful service -&gt; ok"</span></span><br><span class="line">sleep <span class="number">1</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">initHostNameIp()&#123;</span><br><span class="line">echo <span class="string">"#initial os hostname,set ip address.."</span></span><br><span class="line"><span class="preprocessor">#hostNameTmp=zif</span></span><br><span class="line"><span class="preprocessor">#ip_net=$1</span></span><br><span class="line"><span class="preprocessor">#ip=`$&#123;ip_net&#125;.$2`</span></span><br><span class="line"><span class="preprocessor">#sed -i "s/$HOSTNAME/$hostNameTmp/" /etc/hosts</span></span><br><span class="line"><span class="preprocessor">#sed -i "s/$HOSTNAME/$hostNameTmp/" /etc/sysconfig/network</span></span><br><span class="line"><span class="preprocessor">#</span></span><br><span class="line"><span class="preprocessor">#cat&gt;/etc/sysconfig/network-scripts/ifcfg-eth0&lt;&lt;EOF</span></span><br><span class="line"><span class="preprocessor">#DEVICE=eth0</span></span><br><span class="line"><span class="preprocessor">#BOOTPROTO=static</span></span><br><span class="line"><span class="preprocessor">#BROADCAST=$&#123;ip_net&#125;.255</span></span><br><span class="line"><span class="preprocessor">#IPADDR=$ip</span></span><br><span class="line"><span class="preprocessor">#NETMASK=255.255.255.0</span></span><br><span class="line"><span class="preprocessor">#NETWORK=$&#123;ip_net&#125;.0</span></span><br><span class="line"><span class="preprocessor">#GATEWAY=$&#123;ip_net&#125;.1</span></span><br><span class="line"><span class="preprocessor">#ONBOOT=yes</span></span><br><span class="line"><span class="preprocessor">#EOF</span></span><br><span class="line"><span class="preprocessor">##make hostname effect</span></span><br><span class="line"><span class="preprocessor">#hostname $hostNameTmp</span></span><br><span class="line">echo <span class="string">"$ip $hostNameTmp"</span> &gt;&gt;/etc/hosts</span><br><span class="line"><span class="preprocessor">#make ip affect</span></span><br><span class="line">/etc/init.d/network reload</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">initSsh()&#123;</span><br><span class="line">echo <span class="string">"#--sshconfig modify ssh default port,and restrict root user login"</span></span><br><span class="line">\cp /etc/ssh/sshd_config /etc/ssh/ sshd_config.`date +<span class="string">"%Y-%m-%d_%H-%M-%S"</span>`</span><br><span class="line">sed -i <span class="string">'s%#Port 22%Port 52133%'</span> /etc/ssh/sshd_config</span><br><span class="line">sed -i <span class="string">'s%#PermitRootLogin yes%PermitRootLogin no%'</span> /etc/ssh/ sshd_config</span><br><span class="line">sed -i <span class="string">'s%#PermitEmptyPasswords yes$PermitEmptyPasswords no%'</span> /etc/ssh/sshd_config</span><br><span class="line">sed -i <span class="string">'s%#UseDNS yes%UseDNS no%'</span> /etc/ssh/sshd_config</span><br><span class="line">/etc/init.d/sshd reload &amp;&amp; action $<span class="string">"modify ssh default port ,and root login permit:"</span> /bin/<span class="literal">true</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">AddSAUser()&#123;</span><br><span class="line">echo <span class="string">"#--add sys users---"</span></span><br><span class="line">datetmp=`date +<span class="string">"%Y-%m-%d_%H-%M-%S"</span>`</span><br><span class="line">\cp /etc/sudoers /etc/sudoers.$&#123;datetmp&#125;</span><br><span class="line">saUserArr=(zif,zif1,zif2)</span><br><span class="line">groupadd -g <span class="number">888</span> sa</span><br><span class="line"><span class="keyword">for</span>((i=<span class="number">0</span>;i&lt;$&#123;#saUserArr[@]&#125;;i++))</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line"><span class="preprocessor">#addusers</span></span><br><span class="line">useradd -g sa -u <span class="number">88</span>$&#123;i&#125; $&#123;saUserArr[$i]&#125;</span><br><span class="line"><span class="preprocessor">#set user password</span></span><br><span class="line">echo <span class="string">"$&#123;saUserArr[$i]&#125;123"</span>|passwd $&#123;saUserArr[$i]&#125; --<span class="keyword">stdin</span></span><br><span class="line"><span class="preprocessor">#set sudo permit</span></span><br><span class="line">[ `grep <span class="string">"\%sa"</span>|grep -v grep | wc -l` -ne <span class="number">1</span> ] &amp;&amp;\</span><br><span class="line">echo <span class="string">"%sa ALL=(ALL)     NOPASSWD:ALL "</span>&gt;&gt;/etc/sudoers</span><br><span class="line">done</span><br><span class="line">/usr/sbin/visudo -c</span><br><span class="line">[ $? -ne <span class="number">0</span> ] &amp;&amp; /bin/cp /etc/sudoers.$&#123;datetmp&#125; /etc/sudoers &amp;&amp; echo $<span class="string">"sudoers not configured"</span></span><br><span class="line">action $<span class="string">"successfully adduser..-&gt;ok"</span> /bin/<span class="literal">true</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="preprocessor">#set ntp time sync</span></span><br><span class="line"></span><br><span class="line">syncSystemTime()&#123;</span><br><span class="line">echo <span class="string">"set system time sync"</span></span><br><span class="line">if [ `grep <span class="number">10.0</span><span class="number">.0</span><span class="number">.123</span> /<span class="keyword">var</span>/spool/cron/root| grep -v grep | wc -l` -lt <span class="number">1</span> ];then</span><br><span class="line">echo <span class="string">"*/5 * * * * root /usr/sbin/ntpdate 10.0.0.123&gt;/dev/null 2&gt;&amp;1"</span>&gt;&gt;/<span class="keyword">var</span>/spool/cron/root</span><br><span class="line">fi</span><br><span class="line"><span class="preprocessor">#sync systime</span></span><br><span class="line">if [ `grep pool.ntp.org /<span class="keyword">var</span>/spool/cron/root| grep -v grep |wc -l` -lt <span class="number">1</span> ];then</span><br><span class="line">echo <span class="string">"*/5 * * * * /usr/sbin/ntpdate cn.pool.ntp.org &gt;/dev/null 2&gt;&amp;1"</span> &gt;&gt;/<span class="keyword">var</span>/spool/cron/root</span><br><span class="line">fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="preprocessor">#reset the number of openfiles</span></span><br><span class="line">openFiles()&#123;</span><br><span class="line">echo <span class="string">"#modify the maxmium of system files which can opened:65535--"</span></span><br><span class="line">cp /etc/security/limits.conf /etc/security/limits.conf.`date +<span class="string">"%Y-%m-%d_%H-%M-%S"</span>`</span><br><span class="line">sed -i <span class="string">'/# End of file/i\*\t\t-\tnofile\t\t65535'</span> /etc/security/limits.conf</span><br><span class="line">ulimit -HSn <span class="number">65535</span></span><br><span class="line">echo <span class="string">"successfully modified!please reboot the system"</span></span><br><span class="line">sleep <span class="number">1</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="preprocessor">#optimizer os kernel</span></span><br><span class="line">optimizationKernel()&#123;</span><br><span class="line"><span class="preprocessor">#cat &gt;&gt;/etc/sysctl.conf&lt;&lt;OOOF </span></span><br><span class="line"><span class="preprocessor">#net.ipv4.ip_forward = 0 </span></span><br><span class="line"><span class="preprocessor">#net.ipv4.conf.default.rp_filter = 1 </span></span><br><span class="line"><span class="preprocessor">#net.ipv4.conf.default.accept_source_route = 0 </span></span><br><span class="line"><span class="preprocessor">#kernel.sysrq = 0 </span></span><br><span class="line"><span class="preprocessor">#kernel.core_uses_pid = 1 </span></span><br><span class="line"><span class="preprocessor">#net.ipv4.tcp_syncookies = 1 </span></span><br><span class="line"><span class="preprocessor">##net.bridge.bridge-nf-call-ip6tables = 0 </span></span><br><span class="line"><span class="preprocessor">##net.bridge.bridge-nf-call-iptables = 0 </span></span><br><span class="line"><span class="preprocessor">##net.bridge.bridge-nf-call-arptables = 0 </span></span><br><span class="line"><span class="preprocessor">#kernel.msgmnb = 65536 </span></span><br><span class="line"><span class="preprocessor">#kernel.msgmax = 65536 </span></span><br><span class="line"><span class="preprocessor">#kernel.shmmax = 68719476736 </span></span><br><span class="line"><span class="preprocessor">#kernel.shmall = 4294967296 </span></span><br><span class="line"><span class="preprocessor">#net.core.rmem_max = 873200 </span></span><br><span class="line"><span class="preprocessor">#net.core.wmem_max = 873200 </span></span><br><span class="line"><span class="preprocessor">#net.ipv4.tcp_wmem = 8192 436600 873200 </span></span><br><span class="line"><span class="preprocessor">#net.ipv4.tcp_rmem = 8192 436600 873200 </span></span><br><span class="line"><span class="preprocessor">#net.ipv4.tcp_mem = 786432 1048576 1572864 </span></span><br><span class="line"><span class="preprocessor">#net.ipv4.ip_local_port_range = 1024 65000 </span></span><br><span class="line"><span class="preprocessor">#net.ipv4.tcp_max_tw_buckets = 180000 </span></span><br><span class="line"><span class="preprocessor">#net.ipv4.icmp_echo_ignore_broadcasts = 1 </span></span><br><span class="line"><span class="preprocessor">#net.ipv4.tcp_keepalive_probes = 5 </span></span><br><span class="line"><span class="preprocessor">#net.ipv4.tcp_keepalive_intvl = 15 </span></span><br><span class="line"><span class="preprocessor">#net.ipv4.tcp_retries1 = 3 </span></span><br><span class="line"><span class="preprocessor">#net.ipv4.tcp_retries2 = 15 </span></span><br><span class="line"><span class="preprocessor">#net.ipv4.tcp_tw_recycle = 1 </span></span><br><span class="line"><span class="preprocessor">#net.ipv4.tcp_tw_reuse = 1 </span></span><br><span class="line"><span class="preprocessor">#net.ipv4.tcp_max_orphans = 131072 </span></span><br><span class="line"><span class="preprocessor">#net.core.somaxconn = 1024  </span></span><br><span class="line"><span class="preprocessor">#net.core.netdev_max_backlog = 1000 </span></span><br><span class="line"><span class="preprocessor">#net.ipv4.tcp_max_syn_backlog = 20480 </span></span><br><span class="line"><span class="preprocessor">#net.ipv4.tcp_synack_retries = 3 </span></span><br><span class="line"><span class="preprocessor">#net.ipv4.tcp_syn_retries = 3 </span></span><br><span class="line"><span class="preprocessor">#net.ipv4.tcp_window_scaling = 1 </span></span><br><span class="line"><span class="preprocessor">#net.ipv4.tcp_fin_timeout = 30 </span></span><br><span class="line"><span class="preprocessor">#net.ipv4.tcp_keepalive_time = 1800 </span></span><br><span class="line"><span class="preprocessor">#net.ipv4.tcp_sack = 1 </span></span><br><span class="line"><span class="preprocessor">#net.ipv4.tcp_timestamps = 0 </span></span><br><span class="line"><span class="preprocessor">#EOOOF </span></span><br><span class="line"><span class="preprocessor"># </span></span><br><span class="line"><span class="preprocessor">##make optimize effect </span></span><br><span class="line"><span class="preprocessor">#sysctl -p &amp;&amp; action $"optimizer: " /bin/true||action $"optimizer: " /bin/false</span></span><br><span class="line">echo <span class="string">"Optimize kernel"</span> </span><br><span class="line">&#125; </span><br><span class="line">[root@node1 scripts]#</span><br><span class="line"><span class="preprocessor">#TIME_WAIT套接字的最大数量，如果超过这个数字，TIME_WAIT套接字将立刻被清除并打印警告信息。默认为180000，对于apache,nginx等服务器来说可以调整低一点，如：改为5000-30000，不同业务的服务器也可以给大一点，比如lvs,squid。</span></span><br><span class="line">系统安装后的高级调优，包括内核深入优化细节及各种raid制作。此处暂略。</span><br></pre></td></tr></table></figure>
<h3 id="2_-_D服务器配置：">2 - D服务器配置：</h3><h4 id="创建同步目录：">创建同步目录：</h4><figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">mkdir</span> /<span class="typedef"><span class="keyword">data</span>/www/<span class="container">&#123;<span class="title">www</span>,<span class="title">bbs</span>,<span class="title">blog</span>&#125;</span> -p</span></span><br></pre></td></tr></table></figure>
<h4 id="配置密码文件：">配置密码文件：</h4><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">echo <span class="string">"rsync_backup:zif"</span> &gt; /etc/rsync<span class="class">.password</span></span><br><span class="line">chmod <span class="number">600</span> /etc/rsync<span class="class">.password</span> </span><br><span class="line">cat /etc/rsync<span class="class">.password</span> </span><br><span class="line">ll /etc/rsync.password</span><br></pre></td></tr></table></figure>
<h4 id="rsyncd-conf文件快速配置文件：">rsyncd.conf文件快速配置文件：</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">[root@node4 packages]# cat /etc/rsyncd.conf </span><br><span class="line">#rsync_config_______________start</span><br><span class="line">#created by zif 2012-06-27</span><br><span class="line">##rsyncd.conf <span class="operator"><span class="keyword">start</span>##</span><br><span class="line">uid = root</span><br><span class="line">gid = root</span><br><span class="line"><span class="keyword">use</span> chroot = <span class="keyword">no</span></span><br><span class="line"><span class="keyword">max</span> connections = <span class="number">200</span></span><br><span class="line"><span class="keyword">timeout</span> = <span class="number">300</span></span><br><span class="line">pid <span class="keyword">file</span> = /<span class="keyword">var</span>/run/rsyncd.pid</span><br><span class="line"><span class="keyword">lock</span> <span class="keyword">file</span> = /<span class="keyword">var</span>/run/rsync.<span class="keyword">lock</span></span><br><span class="line"><span class="keyword">log</span> <span class="keyword">file</span> = /<span class="keyword">var</span>/<span class="keyword">log</span>/rsyncd.<span class="keyword">log</span></span><br><span class="line"><span class="keyword">ignore</span> <span class="keyword">errors</span></span><br><span class="line"><span class="keyword">read</span> <span class="keyword">only</span> = <span class="literal">false</span></span><br><span class="line"><span class="keyword">list</span> = <span class="literal">false</span></span><br><span class="line"><span class="keyword">hosts</span> <span class="keyword">allow</span> = <span class="number">192.168</span><span class="number">.58</span><span class="number">.0</span>/<span class="number">24</span></span><br><span class="line"><span class="keyword">hosts</span> deny = <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">32</span></span><br><span class="line">auth <span class="keyword">users</span> = rsync_backup</span><br><span class="line">secrets <span class="keyword">file</span> = /etc/rsync.<span class="keyword">password</span></span><br><span class="line">[www]</span><br><span class="line"><span class="keyword">comment</span> = www <span class="keyword">by</span> zif</span><br><span class="line"><span class="keyword">path</span> = /<span class="keyword">data</span>/www/www      </span><br><span class="line">[bbs]</span><br><span class="line"><span class="keyword">comment</span> = bbs <span class="keyword">by</span> zif </span><br><span class="line"><span class="keyword">path</span> = /<span class="keyword">data</span>/www/bbs/</span><br><span class="line"></span><br><span class="line">[blog]</span><br><span class="line"><span class="keyword">comment</span> = blog <span class="keyword">by</span> zif</span><br><span class="line"><span class="keyword">path</span> = /<span class="keyword">data</span>/www/blog</span><br><span class="line">#rsync_config_______________end</span><br><span class="line">[root@node4 packages]#</span></span><br></pre></td></tr></table></figure>
<h4 id="配置密码文件并赋文件权限：">配置密码文件并赋文件权限：</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@node4 packages]<span class="preprocessor"># echo <span class="string">"rsync_backup:zif"</span> &gt; /etc/rsync.password</span></span><br><span class="line">[root@node4 packages]<span class="preprocessor"># chmod <span class="number">600</span> /etc/rsync.password </span></span><br><span class="line">[root@node4 packages]<span class="preprocessor"># cat /etc/rsync.password </span></span><br><span class="line">rsync_backup:zif</span><br><span class="line">[root@node4 packages]<span class="preprocessor"># ll /etc/rsync.password </span></span><br><span class="line">-rw------- <span class="number">1</span> root root <span class="number">17</span> Aug  <span class="number">8</span> <span class="number">20</span>:<span class="number">50</span> /etc/rsync.password</span><br><span class="line">[root@node4 packages]<span class="preprocessor">#</span></span><br></pre></td></tr></table></figure>
<h4 id="以daemon方式运行：">以daemon方式运行：</h4><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">rsync --daemon</span><br><span class="line"><span class="keyword">ps</span> -ef | <span class="keyword">grep</span> rsync</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"/usr/bin/rsync --daemon"</span> &gt;&gt;/etc/rc.local</span><br><span class="line"><span class="keyword">cat</span> /etc/rc.local</span><br></pre></td></tr></table></figure>
<p>重启后，开下进程是否成功运行<br><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr_selector">[root@node4 ~]</span># <span class="tag">netstat</span> <span class="tag">-lnt</span></span><br><span class="line"><span class="tag">Active</span> <span class="tag">Internet</span> <span class="tag">connections</span> (<span class="tag">only</span> <span class="tag">servers</span>)</span><br><span class="line"><span class="tag">Proto</span> <span class="tag">Recv-Q</span> <span class="tag">Send-Q</span> <span class="tag">Local</span> <span class="tag">Address</span>               <span class="tag">Foreign</span> <span class="tag">Address</span>             <span class="tag">State</span>      </span><br><span class="line"><span class="tag">tcp</span>        0      0 0<span class="class">.0</span><span class="class">.0</span><span class="class">.0</span><span class="pseudo">:935</span>                 0<span class="class">.0</span><span class="class">.0</span><span class="class">.0</span>:*                   <span class="tag">LISTEN</span>      </span><br><span class="line"><span class="tag">tcp</span>        0      0 0<span class="class">.0</span><span class="class">.0</span><span class="class">.0</span><span class="pseudo">:873</span>                 0<span class="class">.0</span><span class="class">.0</span><span class="class">.0</span>:*                   <span class="tag">LISTEN</span>      </span><br><span class="line"><span class="tag">tcp</span>        0      0 0<span class="class">.0</span><span class="class">.0</span><span class="class">.0</span><span class="pseudo">:111</span>                 0<span class="class">.0</span><span class="class">.0</span><span class="class">.0</span>:*                   <span class="tag">LISTEN</span>      </span><br><span class="line"><span class="tag">tcp</span>        0      0 0<span class="class">.0</span><span class="class">.0</span><span class="class">.0</span><span class="pseudo">:22</span>                  0<span class="class">.0</span><span class="class">.0</span><span class="class">.0</span>:*                   <span class="tag">LISTEN</span>      </span><br><span class="line"><span class="tag">tcp</span>        0      0 127<span class="class">.0</span><span class="class">.0</span><span class="class">.1</span><span class="pseudo">:25</span>                0<span class="class">.0</span><span class="class">.0</span><span class="class">.0</span>:*                   <span class="tag">LISTEN</span>      </span><br><span class="line"><span class="attr_selector">[root@node4 ~]</span>#</span><br></pre></td></tr></table></figure></p>
<h4 id="客户端配置：">客户端配置：</h4><figure class="highlight coffeescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mkdir <span class="regexp">/data/www/</span>&#123;www,blog,bbs&#125; -p</span><br><span class="line">cd <span class="regexp">/data/www/www/</span></span><br><span class="line">[root<span class="property">@node1</span> www]<span class="comment"># echo " zif" &gt; /etc/rsync.password</span></span><br><span class="line">[root<span class="property">@node1</span> www]<span class="comment"># chmod 600 /etc/rsync.password</span></span><br></pre></td></tr></table></figure>
<p>测试下客户端：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 www]<span class="preprocessor"># touch <span class="number">1.</span>py</span></span><br><span class="line">[root@node1 www]<span class="preprocessor"># </span></span><br><span class="line">[root@node1 www]<span class="preprocessor"># rsync -avz --progress /data/www/www/ rsync_backup@<span class="number">192.168</span><span class="number">.58</span><span class="number">.164</span>::www/ --password-file=/etc/rsync.password </span></span><br><span class="line">sending incremental file <span class="built_in">list</span></span><br><span class="line">./</span><br><span class="line"><span class="number">1.</span>py</span><br><span class="line"><span class="number">0</span> <span class="number">100</span>%    <span class="number">0.00</span>kB/s    <span class="number">0</span>:<span class="number">00</span>:<span class="number">00</span> (xfer<span class="preprocessor">#<span class="number">1</span>, to-check=<span class="number">0</span>/<span class="number">2</span>)</span></span><br><span class="line"></span><br><span class="line">sent <span class="number">74</span> bytes  received <span class="number">30</span> bytes  <span class="number">69.33</span> bytes/sec</span><br><span class="line">total size is <span class="number">0</span>  speedup is <span class="number">0.00</span></span><br><span class="line">[root@node1 www]<span class="preprocessor">#</span></span><br></pre></td></tr></table></figure></p>
<p>其他B,C两个服务器同样配置即可。<br>至此，rsync服务器配置完成；</p>
<h3 id="3_-_C服务器SSHKEY分发服务：">3 - C服务器SSHKEY分发服务：</h3><p>首先要建立一个zif用户（几个服务器都相同很便捷），否则ssh登录时要指定目标机器的免密码用户，其实非相同用户也不是不可。<br>先生成服务端C的公钥私钥：<br><figure class="highlight dos"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ssh-keygen </span><br><span class="line">检查下生成的文件</span><br><span class="line"><span class="built_in">tree</span> ~/.ssh/</span><br><span class="line"><span class="built_in">cd</span> ~</span><br></pre></td></tr></table></figure></p>
<p>通过公钥拷贝工具进行分发(客户端机要建立zif用户)：<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ssh-copy-id -<span class="tag">i</span> ~/.ssh/id_rsa<span class="class">.pub</span> <span class="string">"-p 22 zif@192.168.58.164"</span></span><br><span class="line">ssh-copy-id -<span class="tag">i</span> ~/.ssh/id_rsa<span class="class">.pub</span> <span class="string">"-p 22 zif@192.168.58.161"</span></span><br><span class="line">ssh-copy-id -<span class="tag">i</span> ~/.ssh/id_rsa<span class="class">.pub</span> <span class="string">"-p 22 zif@192.168.58.162"</span></span><br></pre></td></tr></table></figure></p>
<p>检查下是否可以无密码登录：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh <span class="number">192.168</span><span class="number">.58</span><span class="number">.161</span></span><br></pre></td></tr></table></figure></p>
<p>如果机器较多，建议通过EXPECT分发：<br>即，写脚本循环、expect密码后批量分发，记住分发完成后删除该文件（密码敏感信息）</p>
<h3 id="4_-_B服务器数据库配置：">4 - B服务器数据库配置：</h3><p>安装数据库的方法在A服务器配置中已经说明，注意要先创建mysql用户和组；</p>
<h4 id="配置文件的复制：">配置文件的复制：</h4><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">cp support-files/<span class="keyword">my</span>-medium.cnf /usr/<span class="keyword">local</span>/ mysql/<span class="keyword">my</span>.cnf</span><br><span class="line"><span class="comment">#### 创建数据库文件夹：</span></span><br><span class="line">[root<span class="variable">@node2</span> data]<span class="comment"># mkdir -p /usr/local/mysql/data</span></span><br><span class="line">设置权限为Mysql用户</span><br><span class="line">[root<span class="variable">@node2</span> data]<span class="comment"># chown mysql.mysql /usr/local/mysql/data</span></span><br><span class="line">[root<span class="variable">@node2</span> data]<span class="comment"># chown -R mysql /usr/local/mysql</span></span><br></pre></td></tr></table></figure>
<h4 id="安装数据库文件">安装数据库文件</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line">[root@node2 data]# /usr/local/mysql/bin/mysql_install_db <span class="comment">--userysql</span></span><br><span class="line">WARNING: The host 'node2' could not be looked up with resolveip.</span><br><span class="line">This probably means that your libc libraries are not 100 % compatible</span><br><span class="line">with this binary MySQL version. The MySQL daemon, mysqld, should work</span><br><span class="line">normally with the exception that host name resolving will not work.</span><br><span class="line">This means that you should <span class="operator"><span class="keyword">use</span> IP addresses instead <span class="keyword">of</span> hostnames</span><br><span class="line"><span class="keyword">when</span> specifying MySQL <span class="keyword">privileges</span> !</span><br><span class="line">Installing MySQL <span class="keyword">system</span> <span class="keyword">tables</span>...</span><br><span class="line">OK</span><br><span class="line">Filling <span class="keyword">help</span> <span class="keyword">tables</span>...</span><br><span class="line">OK</span><br><span class="line"></span><br><span class="line"><span class="keyword">To</span> <span class="keyword">start</span> mysqld <span class="keyword">at</span> boot <span class="keyword">time</span> you have <span class="keyword">to</span> copy</span><br><span class="line">support-files/mysql.<span class="keyword">server</span> <span class="keyword">to</span> the <span class="keyword">right</span> place <span class="keyword">for</span> your <span class="keyword">system</span></span><br><span class="line"></span><br><span class="line">PLEASE REMEMBER <span class="keyword">TO</span> <span class="keyword">SET</span> A <span class="keyword">PASSWORD</span> <span class="keyword">FOR</span> THE MySQL root <span class="keyword">USER</span> !</span><br><span class="line"><span class="keyword">To</span> <span class="keyword">do</span> so, <span class="keyword">start</span> the <span class="keyword">server</span>, <span class="keyword">then</span> issue the <span class="keyword">following</span> commands:</span><br><span class="line"></span><br><span class="line">/usr/<span class="keyword">local</span>/mysql/<span class="keyword">bin</span>/mysqladmin -u root <span class="keyword">password</span> <span class="string">'new-password'</span></span><br><span class="line">/usr/<span class="keyword">local</span>/mysql/<span class="keyword">bin</span>/mysqladmin -u root -h node2 <span class="keyword">password</span> <span class="string">'new-password'</span></span><br><span class="line"></span><br><span class="line">Alternatively you can run:</span><br><span class="line">/usr/<span class="keyword">local</span>/mysql/<span class="keyword">bin</span>/mysql_secure_installation</span><br><span class="line"></span><br><span class="line">which will also give you the <span class="keyword">option</span> <span class="keyword">of</span> removing the <span class="keyword">test</span></span><br><span class="line"><span class="keyword">databases</span> <span class="keyword">and</span> anonymous <span class="keyword">user</span> created <span class="keyword">by</span> <span class="keyword">default</span>.  This <span class="keyword">is</span></span><br><span class="line">strongly recommended <span class="keyword">for</span> production servers.</span><br><span class="line"></span><br><span class="line">See the <span class="keyword">manual</span> <span class="keyword">for</span> more instructions.</span><br><span class="line"></span><br><span class="line">You can <span class="keyword">start</span> the MySQL daemon <span class="keyword">with</span>:</span><br><span class="line">cd /usr/<span class="keyword">local</span>/mysql ;</span> /usr/local/mysql/bin/mysqld_safe &amp;</span><br><span class="line"></span><br><span class="line">You can test the MySQL daemon with mysql-test-run.pl</span><br><span class="line">cd /usr/local/mysql/mysql-test ; perl mysql-test-run.pl</span><br><span class="line"></span><br><span class="line">Please report any problems with the /usr/local/mysql/bin/mysqlbug script!</span><br><span class="line"></span><br><span class="line">[root@node2 data]#</span><br><span class="line">成功！</span><br><span class="line">#### 查看数据文件：</span><br><span class="line">[root@node2 data]# ls /usr/local/mysql/data/</span><br><span class="line">mysql/ test/  </span><br><span class="line">[root@node2 data]# ls /usr/local/mysql/data/mysql/</span><br><span class="line">columns_priv.frm      plugin.MYI</span><br><span class="line">columns_priv.MYD      proc.frm</span><br><span class="line">columns_priv.MYI      proc.MYD</span><br><span class="line">db.frm                proc.MYI</span><br><span class="line">db.MYD                procs_priv.frm</span><br><span class="line">db.MYI                procs_priv.MYD</span><br><span class="line">event.frm             procs_priv.MYI</span><br><span class="line">event.MYD             servers.frm</span><br><span class="line">event.MYI             servers.MYD</span><br><span class="line">func.frm              servers.MYI</span><br><span class="line">func.MYD              slow_log.CSM</span><br><span class="line">func.MYI              slow_log.CSV</span><br><span class="line">general_log.CSM       slow_log.frm</span><br><span class="line">general_log.CSV       tables_priv.frm</span><br><span class="line">general_log.frm       tables_priv.MYD</span><br><span class="line">help_category.frm     tables_priv.MYI</span><br><span class="line">help_category.MYD     time_zone.frm</span><br><span class="line">help_category.MYI     time_zone_leap_second.frm</span><br><span class="line">help_keyword.frm      time_zone_leap_second.MYD</span><br><span class="line">help_keyword.MYD      time_zone_leap_second.MYI</span><br><span class="line">help_keyword.MYI      time_zone.MYD</span><br><span class="line">help_relation.frm     time_zone.MYI</span><br><span class="line">help_relation.MYD     time_zone_name.frm</span><br><span class="line">help_relation.MYI     time_zone_name.MYD</span><br><span class="line">help_topic.frm        time_zone_name.MYI</span><br><span class="line">help_topic.MYD        time_zone_transition.frm</span><br><span class="line">help_topic.MYI        time_zone_transition.MYD</span><br><span class="line">host.frm              time_zone_transition.MYI</span><br><span class="line">host.MYD              time_zone_transition_type.frm</span><br><span class="line">host.MYI              time_zone_transition_type.MYD</span><br><span class="line">ndb_binlog_index.frm  time_zone_transition_type.MYI</span><br><span class="line">ndb_binlog_index.MYD  user.frm</span><br><span class="line">ndb_binlog_index.MYI  user.MYD</span><br><span class="line">plugin.frm            user.MYI</span><br><span class="line">plugin.MYD</span><br><span class="line">[root@node2 data]#</span><br></pre></td></tr></table></figure>
<h4 id="启动数据库：">启动数据库：</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@node2 mysql-<span class="number">5.1</span><span class="number">.62</span>]<span class="preprocessor"># cp support-files/mysql.server /usr/local/mysql/bin/</span></span><br><span class="line"><span class="preprocessor">#### 到安装目录中将该模板文件拷出</span></span><br><span class="line">[root@node2 mysql-<span class="number">5.1</span><span class="number">.62</span>]<span class="preprocessor"># chmod <span class="number">700</span> /usr/local/mysql/bin/mysql.server </span></span><br><span class="line">[root@node2 mysql-<span class="number">5.1</span><span class="number">.62</span>]<span class="preprocessor"># /usr/local/mysql/bin/mysql.server start</span></span><br><span class="line">Starting MySQL..[  OK  ]</span><br><span class="line">[root@node2 mysql-<span class="number">5.1</span><span class="number">.62</span>]<span class="preprocessor"># netstat -lnt| grep <span class="number">3306</span></span></span><br><span class="line">tcp        <span class="number">0</span>      <span class="number">0</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>:<span class="number">3306</span>                <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>:*                   LISTEN      </span><br><span class="line">[root@node2 mysql-<span class="number">5.1</span><span class="number">.62</span>]<span class="preprocessor"># /usr/local/mysql/bin/mysql.server stop</span></span><br><span class="line">Shutting down MySQL.[  OK  ]</span><br><span class="line">[root@node2 mysql-<span class="number">5.1</span><span class="number">.62</span>]<span class="preprocessor">#</span></span><br></pre></td></tr></table></figure>
<p>配置mysql命令全局使用路径：–服务于下面的配置<br><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="constant">@node2</span> mysql-<span class="number">5.1</span><span class="number">.62</span>]<span class="preprocessor"># echo <span class="string">'export PATH=$PATH:/usr/local/mysql/bin'</span> &gt;&gt; /etc/profile</span></span><br><span class="line">[root<span class="constant">@node2</span> mysql-<span class="number">5.1</span><span class="number">.62</span>]<span class="preprocessor"># source /etc/profile</span></span><br></pre></td></tr></table></figure></p>
<p>配置成标准mysqld start的方式启动数据库：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@node2 mysql-<span class="number">5.1</span><span class="number">.62</span>]<span class="preprocessor"># cp support-files/mysql.server /etc/init.d/mysqld</span></span><br><span class="line">[root@node2 mysql-<span class="number">5.1</span><span class="number">.62</span>]<span class="preprocessor"># chmod <span class="number">700</span> /etc/init.d/mysqld </span></span><br><span class="line">[root@node2 mysql-<span class="number">5.1</span><span class="number">.62</span>]<span class="preprocessor"># /etc/init.d/mysqld restart</span></span><br><span class="line">MySQL manager or server PID file could not be found![FAILED]</span><br><span class="line">Starting MySQL.[  OK  ]</span><br><span class="line">[root@node2 mysql-<span class="number">5.1</span><span class="number">.62</span>]<span class="preprocessor">#</span></span><br></pre></td></tr></table></figure></p>
<h3 id="5_-_A服务器HTTP的配置">5 - A服务器HTTP的配置</h3><h4 id="安装日志轮询工具：">安装日志轮询工具：</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">tar zxf cronolog-<span class="number">1.6</span><span class="number">.2</span>.tar.gz </span><br><span class="line">cd cronolog-<span class="number">1.6</span><span class="number">.2</span></span><br><span class="line">./configure </span><br><span class="line">make &amp;&amp; make install</span><br><span class="line">[root@node1 www]<span class="preprocessor"># mkdir /app/logs/ -p</span></span><br></pre></td></tr></table></figure>
<h4 id="配置主文件：">配置主文件：</h4><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># ServerName gives the name and port that the server uses to identify itself.</span></span><br><span class="line"><span class="comment"># This can often be determined automatically, but we recommend you specify</span></span><br><span class="line"><span class="comment"># it explicitly to prevent problems during startup.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># If your host doesn't have a registered DNS name, enter its IP address here.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#ServerName www.example.com:80</span></span><br><span class="line"><span class="title">ServerName</span> <span class="number">127.0.0.1:80</span></span><br><span class="line"><span class="comment"># Virtual hosts</span></span><br><span class="line">Include conf/extra/httpd-vhosts.conf</span><br></pre></td></tr></table></figure>
<h4 id="配置虚拟主机文件：">配置虚拟主机文件：</h4><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># VirtualHost example:</span></span><br><span class="line"><span class="comment"># Almost any Apache directive may go into a VirtualHost container.</span></span><br><span class="line"><span class="comment"># The first VirtualHost section is used for all requests that do not</span></span><br><span class="line"><span class="comment"># match a ServerName or ServerAlias in any &lt;VirtualHost&gt; block.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">&lt;VirtualHost *:<span class="number">80</span>&gt;</span><br><span class="line">ServerAdmin zif<span class="variable">@dummy</span>-host.example.com</span><br><span class="line">DocumentRoot <span class="string">"/data/www/www"</span></span><br><span class="line">ServerName www.zif.com</span><br><span class="line">ServerAlias zif.com</span><br><span class="line">ErrorLog <span class="string">"logs/zif.www.com-error_log"</span></span><br><span class="line"><span class="comment">#    CustomLog "logs/zif.com-access_log" common</span></span><br><span class="line">CustomLog <span class="string">"|/usr/local/sbin/cronolog /app/logs/access_www_<span class="variable">%Y</span><span class="variable">%m</span><span class="variable">%d</span>.log"</span> combined</span><br><span class="line">&lt;<span class="regexp">/VirtualHost&gt;</span><br><span class="line">&lt;VirtualHost *:80&gt;</span><br><span class="line">ServerAdmin zif@dummy-host.example.com</span><br><span class="line">DocumentRoot "/data</span><span class="regexp">/www/bbs</span><span class="string">"</span><br><span class="line">ServerName bbs.zif.com</span><br><span class="line">ErrorLog "</span>logs/zif.bbs.com-error_log<span class="string">"</span><br><span class="line">CustomLog "</span>|<span class="regexp">/usr/local</span><span class="regexp">/sbin/cronolog</span> /app/logs/access_bbs<span class="number">_</span><span class="variable">%Y</span><span class="variable">%m</span><span class="variable">%d</span>.<span class="keyword">log</span><span class="string">" combined</span><br><span class="line">&lt;/VirtualHost&gt;</span><br><span class="line">&lt;VirtualHost *:80&gt;</span><br><span class="line">ServerAdmin zif<span class="variable">@dummy</span>-host.example.com</span><br><span class="line">DocumentRoot "</span>/data/www/blog<span class="string">"</span><br><span class="line">ServerName blog.zif.com</span><br><span class="line">ErrorLog "</span>logs/zif.blog.com-error_log<span class="string">"</span><br><span class="line">#    CustomLog "</span>logs/zif.com-access_log<span class="string">" common</span><br><span class="line">CustomLog "</span>|<span class="regexp">/usr/local</span><span class="regexp">/sbin/cronolog</span> /app/logs/access_blog<span class="variable">%Y</span><span class="variable">%m</span><span class="variable">%d</span>.<span class="keyword">log</span><span class="string">" combined</span><br><span class="line">&lt;/VirtualHost&gt;</span><br><span class="line">~</span><br><span class="line">~</span><br><span class="line">~</span><br><span class="line">"</span>extra/httpd-vhosts.conf<span class="string">" 50L, 1746C written</span></span><br></pre></td></tr></table></figure>
<h4 id="检查整体配置：">检查整体配置：</h4><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="constant">@node1</span> conf]<span class="preprocessor"># ../../apache/bin/apachectl -t</span></span><br><span class="line">Syntax OK</span><br><span class="line">[root<span class="constant">@node1</span> conf]<span class="preprocessor">#</span></span><br></pre></td></tr></table></figure>
<h4 id="创建各个主页文件：">创建各个主页文件：</h4><figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 conf]# echo welcome &gt; /<span class="typedef"><span class="keyword">data</span>/www/<span class="container">&#123;<span class="title">www</span>,<span class="title">bbs</span>,<span class="title">blog</span>&#125;</span>/index.html</span></span><br><span class="line">-bash: /<span class="typedef"><span class="keyword">data</span>/www/<span class="container">&#123;<span class="title">www</span>,<span class="title">bbs</span>,<span class="title">blog</span>&#125;</span>/index.html: ambiguous redirect</span></span><br><span class="line">[root@node1 conf]# for n <span class="keyword">in</span> `ls /<span class="typedef"><span class="keyword">data</span>/www`;do echo $n &gt;/<span class="keyword">data</span>/www/$n/index.html;done</span></span><br><span class="line">[root@node1 conf]# tree /<span class="typedef"><span class="keyword">data</span>/www/</span></span><br><span class="line">/<span class="typedef"><span class="keyword">data</span>/www/</span></span><br><span class="line">|<span class="comment">-- bbs</span></span><br><span class="line">|   `<span class="comment">-- index.html</span></span><br><span class="line">|<span class="comment">-- blog</span></span><br><span class="line">|   `<span class="comment">-- index.html</span></span><br><span class="line">`<span class="comment">-- www</span></span><br><span class="line">|<span class="comment">-- 1.py</span></span><br><span class="line">`<span class="comment">-- index.html</span></span><br><span class="line"></span><br><span class="line"><span class="number">3</span> directories, <span class="number">4</span> files</span><br><span class="line">[root@node1 conf]#</span><br></pre></td></tr></table></figure>
<h4 id="测试">测试</h4><blockquote>
<p>得到一个403的禁止访问错误，原因要配置目录访问权限：</p>
</blockquote>
<figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 www]<span class="comment"># egrep -v '#|^$' /application/apache/conf/httpd.conf</span></span><br><span class="line">ServerRoot <span class="string">"/application/apache2.2.23"</span></span><br><span class="line">Listen <span class="number">80</span></span><br><span class="line"><span class="variable">&lt;IfModule !mpm_netware_module&gt;</span></span><br><span class="line"><span class="variable">&lt;IfModule !mpm_winnt_module&gt;</span></span><br><span class="line">User daemon</span><br><span class="line">Group daemon</span><br><span class="line"><span class="variable">&lt;/IfModule&gt;</span></span><br><span class="line"><span class="variable">&lt;/IfModule&gt;</span></span><br><span class="line">ServerAdmin you@example.com</span><br><span class="line">ServerName <span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">80</span></span><br><span class="line">DocumentRoot <span class="string">"/application/apache2.2.23/htdocs"</span></span><br><span class="line"><span class="variable">&lt;Directory /&gt;</span></span><br><span class="line">Options FollowSymLinks</span><br><span class="line">AllowOverride None</span><br><span class="line">Order deny,allow</span><br><span class="line">Deny <span class="keyword">from</span> <span class="literal">all</span></span><br><span class="line"><span class="variable">&lt;/Directory&gt;</span></span><br><span class="line"><span class="variable">&lt;Directory /data/www&gt;</span></span><br><span class="line">Options -Indexes FollowSymLinks</span><br><span class="line">AllowOverride None</span><br><span class="line">Order allow,deny</span><br><span class="line">Allow <span class="keyword">from</span> <span class="literal">all</span></span><br><span class="line"><span class="variable">&lt;/Directory&gt;</span></span><br><span class="line"><span class="variable">&lt;Directory "/application/apache2.2.23/htdocs"&gt;</span></span><br><span class="line">Options Indexes FollowSymLinks</span><br><span class="line">AllowOverride None</span><br><span class="line">Order allow,deny</span><br><span class="line">Allow <span class="keyword">from</span> <span class="literal">all</span></span><br><span class="line"><span class="variable">&lt;/Directory&gt;</span></span><br><span class="line"><span class="variable">&lt;IfModule dir_module&gt;</span></span><br><span class="line">DirectoryIndex index.html</span><br><span class="line"><span class="variable">&lt;/IfModule&gt;</span></span><br><span class="line"><span class="variable">&lt;FilesMatch "^\.ht"&gt;</span></span><br><span class="line">Order allow,deny</span><br><span class="line">Deny <span class="keyword">from</span> <span class="literal">all</span></span><br><span class="line">Satisfy All</span><br><span class="line"><span class="variable">&lt;/FilesMatch&gt;</span></span><br><span class="line">ErrorLog <span class="string">"logs/error_log"</span></span><br><span class="line">LogLevel warn</span><br><span class="line"><span class="variable">&lt;IfModule log_config_module&gt;</span></span><br><span class="line">LogFormat <span class="string">"%h %l %u %t \"%r\" %&gt;s %b \"%&#123;Referer&#125;i\" \"%&#123;User-Agent&#125;i\""</span> combined</span><br><span class="line">LogFormat <span class="string">"%h %l %u %t \"%r\" %&gt;s %b"</span> common</span><br><span class="line"><span class="variable">&lt;IfModule logio_module&gt;</span></span><br><span class="line">LogFormat <span class="string">"%h %l %u %t \"%r\" %&gt;s %b \"%&#123;Referer&#125;i\" \"%&#123;User-Agent&#125;i\" %I %O"</span> combinedio</span><br><span class="line"><span class="variable">&lt;/IfModule&gt;</span></span><br><span class="line">CustomLog <span class="string">"logs/access_log"</span> common</span><br><span class="line"><span class="variable">&lt;/IfModule&gt;</span></span><br><span class="line"><span class="variable">&lt;IfModule alias_module&gt;</span></span><br><span class="line">ScriptAlias /cgi-bin/ <span class="string">"/application/apache2.2.23/cgi-bin/"</span></span><br><span class="line"><span class="variable">&lt;/IfModule&gt;</span></span><br><span class="line"><span class="variable">&lt;IfModule cgid_module&gt;</span></span><br><span class="line"><span class="variable">&lt;/IfModule&gt;</span></span><br><span class="line"><span class="variable">&lt;Directory "/application/apache2.2.23/cgi-bin"&gt;</span></span><br><span class="line">AllowOverride None</span><br><span class="line">Options None</span><br><span class="line">Order allow,deny</span><br><span class="line">Allow <span class="keyword">from</span> <span class="literal">all</span></span><br><span class="line"><span class="variable">&lt;/Directory&gt;</span></span><br><span class="line">DefaultType text/plain</span><br><span class="line"><span class="variable">&lt;IfModule mime_module&gt;</span></span><br><span class="line">TypesConfig conf/mime.types</span><br><span class="line">AddType application/x-compress .Z</span><br><span class="line">AddType application/x-gzip .gz .tgz</span><br><span class="line"><span class="variable">&lt;/IfModule&gt;</span></span><br><span class="line">Include conf/extra/httpd-vhosts.conf</span><br><span class="line"><span class="variable">&lt;IfModule ssl_module&gt;</span></span><br><span class="line">SSLRandomSeed startup builtin</span><br><span class="line">SSLRandomSeed connect builtin</span><br><span class="line"><span class="variable">&lt;/IfModule&gt;</span></span><br><span class="line">[root@node1 www]<span class="comment">#</span></span><br></pre></td></tr></table></figure>
<p>重启<br><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="constant">@node1</span> www]<span class="preprocessor"># /application/apache/bin/apachectl graceful</span></span><br><span class="line">ok：</span><br></pre></td></tr></table></figure></p>
<h4 id="安装PHP：">安装PHP：</h4><figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cd /data/packages/php-<span class="number">5.3</span>.<span class="number">15</span></span><br><span class="line">make &amp;&amp; make install</span><br><span class="line">ln -s /application/php5.<span class="number">3.10</span> /application/php</span><br><span class="line">cp php.ini-production /application/php/<span class="class"><span class="keyword">lib</span>/<span class="title">php</span>.<span class="title">ini</span></span></span><br><span class="line">history</span><br></pre></td></tr></table></figure>
<h4 id="配置apache支持php：">配置apache支持php：</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 php-<span class="number">5.3</span><span class="number">.15</span>]<span class="preprocessor"># cd /application/apache/conf/</span></span><br><span class="line">[root@node1 conf]<span class="preprocessor"># cp httpd.conf httpd.conf.zif<span class="number">.20130808</span></span></span><br><span class="line">[root@node1 conf]<span class="preprocessor"># vim /application/apache/conf/httpd.conf +<span class="number">98</span></span></span><br><span class="line"><span class="preprocessor">#</span></span><br><span class="line"><span class="preprocessor">#ServerName www.example.com:<span class="number">80</span></span></span><br><span class="line">ServerName <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">80</span></span><br></pre></td></tr></table></figure>
<p>转到311行，添加两行：<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">AddType application/x-httpd-php <span class="class">.php</span> <span class="class">.phtml</span></span><br><span class="line">AddType application/x-httpd-php-source .phps</span><br></pre></td></tr></table></figure></p>
<p>转到64行，修改daemon用户为apache<br><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 ~]<span class="comment"># grep apache /etc/passwd</span></span><br><span class="line">[root@node1 ~]<span class="comment"># useradd apache -M -s /sbin/nologin</span></span><br><span class="line">[root@node1 ~]<span class="comment">#</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">User</span> <span class="title">apache</span></span><br><span class="line"><span class="keyword">Group</span> <span class="title">apache</span></span><br></pre></td></tr></table></figure></p>
<h4 id="修改首页文件：">修改首页文件：</h4><figure class="highlight axapta"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DirectoryIndex <span class="keyword">index</span>.php <span class="keyword">index</span>.html</span><br></pre></td></tr></table></figure>
<p>www下建立一个phpinfo，你懂的，ok了：<br><img src="http://gitimg.qiniudn.com/diary1_test_img_009.png" alt="phpinfo信息"></p>
<h3 id="编译安装php扩展：">编译安装php扩展：</h3><h4 id="安装eaccelerator缓存加速模块：">安装eaccelerator缓存加速模块：</h4><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">echo</span> <span class="string">'export LC_ALL=C'</span> &gt;&gt; /etc/<span class="keyword">profile</span></span><br><span class="line"><span class="keyword">source</span> /etc/<span class="keyword">profile</span></span><br><span class="line"><span class="keyword">cd</span> ../../packages/</span><br><span class="line">tar jxf eaccelerator-<span class="number">0.9</span>.<span class="number">6</span>.tar.bz2 </span><br><span class="line"><span class="keyword">cd</span> eaccelerator-<span class="number">0.9</span>.<span class="number">6</span></span><br><span class="line">export PHP_PREFIX=<span class="string">"/application/php/"</span></span><br><span class="line">$PHP_PREFIX/bin/phpize</span><br><span class="line">./configure --enable-eaccelerator=shared --with-php-config=/application/php/bin/php-config</span><br><span class="line"><span class="keyword">make</span> &amp;&amp; <span class="keyword">make</span> install</span><br></pre></td></tr></table></figure>
<p>配置eaccelerator：<br><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@node1</span> imagick-<span class="number">3.1</span>.0RC2]<span class="comment"># mkdir -p /tmp/eaccelerator</span></span><br><span class="line">[root<span class="variable">@node1</span> imagick-<span class="number">3.1</span>.0RC2]<span class="comment"># chown -R apache.apache /tmp/eaccelerator </span></span><br><span class="line">[root<span class="variable">@node1</span> imagick-<span class="number">3.1</span>.0RC2]<span class="comment"># egrep "User|Group" /application/apache/conf/httpd.conf</span></span><br><span class="line"><span class="comment"># User/Group: The name (or #number) of the user/group to run httpd as.</span></span><br><span class="line">User apache</span><br><span class="line">Group apache</span><br><span class="line">LogFormat <span class="string">"<span class="variable">%h</span> <span class="variable">%l</span> <span class="variable">%u</span> <span class="variable">%t</span> \"<span class="variable">%r</span>\" <span class="variable">%&gt;</span>s <span class="variable">%b</span> \"<span class="variable">%&#123;Referer&#125;</span>i\" \"%&#123;User-Agent&#125;i\""</span> combined</span><br><span class="line">LogFormat <span class="string">"<span class="variable">%h</span> <span class="variable">%l</span> <span class="variable">%u</span> <span class="variable">%t</span> \"<span class="variable">%r</span>\" <span class="variable">%&gt;</span>s <span class="variable">%b</span> \"<span class="variable">%&#123;Referer&#125;</span>i\" \"%&#123;User-Agent&#125;i\" <span class="variable">%I</span> <span class="variable">%O</span>"</span> combinedio</span><br><span class="line"><span class="comment"># User home directories</span></span><br><span class="line">[root<span class="variable">@node1</span> imagick-<span class="number">3.1</span>.0RC2]<span class="comment">#</span></span><br></pre></td></tr></table></figure></p>
<h4 id="安装imagick扩展：">安装imagick扩展：</h4><figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">yum install <span class="constant">ImageMagick</span> <span class="constant">ImageMagick</span>-devel   --此处也可编译安装</span><br><span class="line"></span><br><span class="line">wget <span class="symbol">http:</span>/<span class="regexp">/pecl.php.net/get</span><span class="regexp">/imagick-3.1.0RC2.tgz</span><br><span class="line">tar zxf imagick-3.1.0RC2.tgz </span><br><span class="line">cd imagick-3.1.0RC2</span><br><span class="line">/application</span><span class="regexp">/php/bin</span><span class="regexp">/phpize </span><br><span class="line">./configure</span> --<span class="keyword">with</span>-php-config=<span class="regexp">/application/php</span><span class="regexp">/bin/php</span>-config</span><br><span class="line"></span><br><span class="line">make &amp;&amp; make install</span><br></pre></td></tr></table></figure>
<h3 id="6_-_安装应用：">6 - 安装应用：</h3><h4 id="B服务器：数据库处理：">B服务器：数据库处理：</h4><p>删除多余的数据库用户：<br><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; <span class="keyword">drop</span> user <span class="string">""</span>@localhost;</span><br><span class="line"><span class="keyword">Query</span> OK, 0 rows affected (0.05 sec)</span><br><span class="line">mysql&gt; <span class="keyword">drop</span> user <span class="string">""</span>@node2;    </span><br><span class="line"><span class="keyword">Query</span> OK, 0 rows affected (0.00 sec)</span><br><span class="line">mysql&gt; <span class="keyword">drop</span> user <span class="string">"root"</span>@node2;</span><br><span class="line"><span class="keyword">Query</span> OK, 0 rows affected (0.00 sec)</span><br></pre></td></tr></table></figure></p>
<p>创建数据库：<br><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; create database blog<span class="comment">;</span></span><br><span class="line">mysql&gt; create database www<span class="comment">;</span></span><br></pre></td></tr></table></figure></p>
<p>创建用户、对应用户和数据库并赋予权限：<br><figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; grant <span class="keyword">select</span>,insert,update,delete,alter,create <span class="keyword">on</span> www<span class="built_in">.</span>* <span class="keyword">to</span> www@<span class="string">'192.168.58.%'</span> identified <span class="keyword">by</span> <span class="string">'123456'</span>;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.04</span> sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; grant <span class="keyword">select</span>,insert,update,delete,alter,create <span class="keyword">on</span> blog<span class="built_in">.</span>* <span class="keyword">to</span> blog@<span class="string">'192.168.58.%'</span> identified <span class="keyword">by</span> <span class="string">'123456'</span>;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure></p>
<h4 id="A应用服务器">A应用服务器</h4><p>下载cms、blog等程序并分别解压到 /data/www/{www,blog}目录；<br>分别将所有权赋给apache:<br><figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 www]# chown -<span class="type">R</span> apache /<span class="typedef"><span class="keyword">data</span>/www/<span class="container">&#123;<span class="title">www</span>,<span class="title">blog</span>&#125;</span></span></span><br></pre></td></tr></table></figure></p>
<h4 id="客户端host处理（或局域网DNS服务器）">客户端host处理（或局域网DNS服务器）</h4><p>修改客户端windows的hosts文件：<br><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">路径：</span><br><span class="line"><span class="tag">C</span>:\<span class="tag">Windows</span>\<span class="tag">System32</span>\<span class="tag">drivers</span>\<span class="tag">etc</span></span><br><span class="line">修改内容为：</span><br><span class="line">192<span class="class">.168</span><span class="class">.0</span><span class="class">.11</span>  <span class="tag">blog</span><span class="class">.zif</span><span class="class">.com</span></span><br><span class="line">192<span class="class">.168</span><span class="class">.0</span><span class="class">.11</span>  <span class="tag">www</span><span class="class">.zif</span><span class="class">.com</span></span><br><span class="line">192<span class="class">.168</span><span class="class">.0</span><span class="class">.11</span>  <span class="tag">zif</span><span class="class">.com</span></span><br><span class="line">192<span class="class">.168</span><span class="class">.0</span><span class="class">.11</span>  <span class="tag">status</span><span class="class">.ifcheung</span><span class="class">.org</span></span><br></pre></td></tr></table></figure></p>
<p>C nfs服务器：<br>启动服务（注意顺序）：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/etc/init.d/portmap <span class="operator"><span class="keyword">start</span></span><br><span class="line">/etc/init.<span class="keyword">d</span>/nfs <span class="keyword">start</span></span></span><br></pre></td></tr></table></figure></p>
<p>查看现有配置：<br><figure class="highlight delphi"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat /etc/<span class="keyword">exports</span></span><br></pre></td></tr></table></figure></p>
<p>创建备份目录并授权：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir /<span class="operator"><span class="keyword">backup</span> -<span class="keyword">p</span></span><br><span class="line">chown nfsnobody /<span class="keyword">backup</span></span></span><br></pre></td></tr></table></figure></p>
<p>添加配置：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/exports</span><br><span class="line">[root@node3 ~]<span class="preprocessor"># cat /etc/exports </span></span><br><span class="line">/backup <span class="number">192.168</span><span class="number">.58</span><span class="number">.0</span>/<span class="number">24</span>(rw,sync,all_sqush,anonuid=<span class="number">65534</span>,anongid=<span class="number">65534</span>)</span><br></pre></td></tr></table></figure></p>
<p>查看需要共享的A、B、D的用户ID是否一致（注意64位机）：<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@node2</span> ~]<span class="comment"># grep nfsno /etc/passwd</span></span><br><span class="line"><span class="symbol">nfsnobody:</span><span class="symbol">x:</span><span class="number">65534</span><span class="symbol">:</span><span class="number">65534</span><span class="symbol">:Anonymous</span> <span class="constant">NFS</span> <span class="constant">User</span><span class="symbol">:/var/lib/nfs</span><span class="symbol">:/sbin/nologin</span></span><br><span class="line">[root<span class="variable">@node2</span> ~]<span class="comment">#</span></span><br></pre></td></tr></table></figure></p>
<p>检查下配置<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@node3 ~]<span class="preprocessor"># cat /etc/exports </span></span><br><span class="line">/backup <span class="number">192.168</span><span class="number">.58</span><span class="number">.0</span>/<span class="number">24</span>(rw,sync,all_sqush,anonuid=<span class="number">65534</span>,anongid=<span class="number">65534</span>)</span><br></pre></td></tr></table></figure></p>
<p>重启nfs服务：<br><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="constant">@node3</span> ~]<span class="preprocessor"># /etc/init.d/nfs reload</span></span><br><span class="line">[root<span class="constant">@node3</span> ~]<span class="preprocessor">#</span></span><br></pre></td></tr></table></figure></p>
<p>ok，检查是否在其他机器生效：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 ~]<span class="preprocessor"># showmount -e <span class="number">192.168</span><span class="number">.58</span><span class="number">.163</span></span></span><br><span class="line">Export <span class="built_in">list</span> <span class="keyword">for</span> <span class="number">192.168</span><span class="number">.58</span><span class="number">.163</span>:</span><br><span class="line">/backup <span class="number">192.168</span><span class="number">.58</span><span class="number">.0</span>/<span class="number">24</span></span><br><span class="line">[root@node1 ~]<span class="preprocessor"># mount -t nfs <span class="number">192.168</span><span class="number">.58</span><span class="number">.163</span>:/backup /mnt</span></span><br><span class="line">[root@node1 ~]<span class="preprocessor"># touch /mnt/nfs.py</span></span><br><span class="line">[root@node1 ~]<span class="preprocessor">#</span></span><br></pre></td></tr></table></figure></p>
<p>再回到NFS服务器查看：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@node3 ~]<span class="preprocessor"># ls /backup/ -l</span></span><br><span class="line">total <span class="number">0</span></span><br><span class="line">-rw-r--r-- <span class="number">1</span> nfsnobody nfsnobody <span class="number">0</span> Aug  <span class="number">9</span> <span class="number">00</span>:<span class="number">07</span> nfs.py</span><br><span class="line">[root@node3 ~]<span class="preprocessor">#</span></span><br><span class="line">C nfs服务器：</span><br><span class="line">[root@node3 backup]<span class="preprocessor"># mkdir www-upload/allimg/ -p</span></span><br><span class="line">[root@node3 backup]<span class="preprocessor">#</span></span><br></pre></td></tr></table></figure></p>
<p>A web服务器上传目录：<br><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 uploads]# mount -t nfs <span class="number">192.168</span>.<span class="number">58.163</span>:<span class="regexp">/backup/</span>www-upload<span class="regexp">/allimg/</span> <span class="regexp">/data/</span>www<span class="regexp">/www/u</span>ploads<span class="regexp">/allimg/</span></span><br><span class="line">注意这里的目录要最外子目录，的挂载，主要是由于apache是通过apache用户来上传的，而挂载之后目录中的文件是以nfsnobody来处理的，这里有些不太明白！！</span><br></pre></td></tr></table></figure></p>
<h3 id="7_-_定时备份任务">7 - 定时备份任务</h3><h4 id="A服务器备份并推送至D：">A服务器备份并推送至D：</h4><p>需要压缩A上需要备份的文件，然后同步到备份服务器D中的指定目录，并删除A本地临时备份目录中7天前的备份文件，定时备份脚本如下：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 scripts]# vim <span class="operator"><span class="keyword">backup</span>.sh </span><br><span class="line">#!/<span class="keyword">bin</span>/sh</span><br><span class="line">#zif zif@gmail.com</span><br><span class="line">[ ! -<span class="keyword">d</span> /<span class="keyword">server</span>/<span class="keyword">backup</span> ] &amp;&amp; mkdir -<span class="keyword">p</span> /<span class="keyword">server</span>/<span class="keyword">backup</span>   如果不存在备份目录就创建一个</span><br><span class="line">#<span class="keyword">backup</span> web <span class="keyword">data</span></span><br><span class="line">cd /<span class="keyword">data</span>/ &amp;&amp; tar zcf /<span class="keyword">server</span>/<span class="keyword">backup</span>/<span class="string">`ifconfig eth0 | sed -n 's#^.*addr:\(.*\)  Bca.*$#\1#gp'`</span>_<span class="string">`uname -n`</span>_www_$(<span class="built_in">date</span> +%<span class="keyword">F</span>).tar.gz ./www</span><br><span class="line">#rsync <span class="keyword">to</span> node4</span><br><span class="line">rsync -avzP /<span class="keyword">server</span>/<span class="keyword">backup</span>/ rsync_backup@<span class="number">192.168</span><span class="number">.58</span><span class="number">.164</span>::bbs/ <span class="comment">--password-file=/etc/rsync.password</span></span><br><span class="line">#del <span class="keyword">backup</span> <span class="keyword">file</span> <span class="keyword">in</span> past <span class="number">7</span> <span class="keyword">days</span></span><br><span class="line">find /<span class="keyword">server</span>/<span class="keyword">backup</span> -<span class="keyword">name</span> <span class="string">"*.tar.gz"</span> -mtime +<span class="number">7</span> |xargs rm -<span class="keyword">f</span></span></span><br></pre></td></tr></table></figure></p>
<p>将该脚本加入到定时任务中， crontab -e 修改如下：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 scripts]<span class="preprocessor"># crontab -e</span></span><br><span class="line">*/<span class="number">5</span> * * * * root /usr/sbin/ntpdate <span class="number">10.0</span><span class="number">.0</span><span class="number">.123</span>&gt;/dev/null <span class="number">2</span>&gt;&amp;<span class="number">1</span></span><br><span class="line">*/<span class="number">5</span> * * * * /usr/sbin/ntpdate cn.pool.ntp.org &gt;/dev/null <span class="number">2</span>&gt;&amp;<span class="number">1</span></span><br><span class="line"><span class="number">00</span> <span class="number">00</span> * * * /bin/sh /server/scripts/backup.sh &gt;/dev/null <span class="number">2</span>&gt;&amp;<span class="number">1</span></span><br></pre></td></tr></table></figure></p>
<p>执行效果，A上：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 scripts]<span class="preprocessor"># sh backup.sh </span></span><br><span class="line">sending incremental file <span class="built_in">list</span></span><br><span class="line"><span class="number">192.168</span><span class="number">.0</span><span class="number">.11</span>_node1_www_2013-<span class="number">08</span>-<span class="number">17.</span>tar.gz</span><br><span class="line"><span class="number">18459394</span> <span class="number">100</span>%   <span class="number">20.16</span>MB/s    <span class="number">0</span>:<span class="number">00</span>:<span class="number">00</span> (xfer<span class="preprocessor">#<span class="number">1</span>, to-check=<span class="number">0</span>/<span class="number">2</span>)</span></span><br><span class="line"></span><br><span class="line">sent <span class="number">4419</span> bytes  received <span class="number">25809</span> bytes  <span class="number">12091.20</span> bytes/sec</span><br><span class="line">total size is <span class="number">18459394</span>  speedup is <span class="number">610.67</span></span><br><span class="line">[root@node1 scripts]<span class="preprocessor"># ll ../backup/</span></span><br><span class="line">total <span class="number">18052</span></span><br><span class="line">-rw-r--r-- <span class="number">1</span> root root <span class="number">18459394</span> Aug <span class="number">17</span> <span class="number">11</span>:<span class="number">24</span> <span class="number">192.168</span><span class="number">.0</span><span class="number">.11</span>_node1_www_2013-<span class="number">08</span>-<span class="number">17.</span>tar.gz</span><br><span class="line">D上：</span><br><span class="line">-rw-r--r-- <span class="number">1</span> root root <span class="number">18459394</span> Aug <span class="number">17</span>  <span class="number">2013</span> <span class="number">192.168</span><span class="number">.0</span><span class="number">.11</span>_node1_www_2013-<span class="number">08</span>-<span class="number">17.</span>tar.gz</span><br></pre></td></tr></table></figure></p>
<p>那么这里的备份用户是rsync_nobody，还应该是root呢？</p>
<h4 id="B数据库服务器备份至D：">B数据库服务器备份至D：</h4><p>思路：通过Mysqldump命令和对应数据库的授权用户，将数据库导出并压缩后同步到D服务器，并删除A上临时备份的7天前的数据：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/sh</span><br><span class="line">#zif zif@gmail.com</span><br><span class="line">#<span class="operator"><span class="keyword">prepare</span></span><br><span class="line">[ ! -<span class="keyword">d</span> /<span class="keyword">server</span>/<span class="keyword">backup</span> ] &amp;&amp; mkdir -<span class="keyword">p</span> /<span class="keyword">server</span>/<span class="keyword">backup</span></span><br><span class="line"></span><br><span class="line">#<span class="keyword">backup</span> web <span class="keyword">data</span></span><br><span class="line">mysqldump -uroot -<span class="keyword">p</span><span class="string">'123456'</span>-A -B|gzip &gt;/<span class="keyword">server</span>/<span class="keyword">backup</span>/<span class="string">`ifconfig eth0 | sed -n 's#^.*addr:\(.*\)  Bca.*$#\1#gp'`</span>_<span class="string">`uname -n`</span>_www_$(<span class="built_in">date</span> +%<span class="keyword">F</span>).tar.gz</span><br><span class="line"></span><br><span class="line">#rsync <span class="keyword">to</span> node4</span><br><span class="line">rsync -avzP /<span class="keyword">server</span>/<span class="keyword">backup</span>/ rsync_backup@<span class="number">192.168</span><span class="number">.58</span><span class="number">.164</span>::bbs/ <span class="comment">--password-file=/etc/rsync.password</span></span><br><span class="line"></span><br><span class="line">#del <span class="keyword">backup</span> <span class="keyword">file</span> <span class="keyword">in</span> past <span class="number">7</span> <span class="keyword">days</span></span><br><span class="line">find /<span class="keyword">server</span>/<span class="keyword">backup</span> -<span class="keyword">name</span> <span class="string">"*.tar.gz"</span> -mtime +<span class="number">7</span> |xargs rm -<span class="keyword">f</span></span></span><br></pre></td></tr></table></figure></p>
<p>将该脚本加入到B定时任务中去：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@node2 scripts]<span class="preprocessor"># crontab -e</span></span><br><span class="line">no crontab <span class="keyword">for</span> root - <span class="keyword">using</span> an empty one</span><br><span class="line">*/<span class="number">5</span> * * * * /usr/sbin/ntpdate cn.pool.ntp.org &gt;/dev/null <span class="number">2</span>&gt;&amp;<span class="number">1</span></span><br><span class="line"><span class="number">00</span> <span class="number">00</span> * * * /bin/sh /server/scripts/backup.sh &gt;/dev/null <span class="number">2</span>&gt;&amp;<span class="number">1</span></span><br><span class="line">备份效果D：</span><br><span class="line">-rw-r--r-- <span class="number">1</span> root root <span class="number">18459394</span> Aug <span class="number">17</span>  <span class="number">2013</span> <span class="number">192.168</span><span class="number">.58</span><span class="number">.161</span>_node1_www_2013-<span class="number">08</span>-<span class="number">17.</span>tar.gz</span><br><span class="line">-rw-r--r-- <span class="number">1</span> root root      <span class="number">130</span> Aug  <span class="number">9</span>  <span class="number">2013</span> <span class="number">192.168</span><span class="number">.58</span><span class="number">.162</span>_node2_www_2013-<span class="number">08</span>-<span class="number">09.</span>tar.gz</span><br></pre></td></tr></table></figure></p>
<h4 id="C同步服务器监视文件上传目录到D：">C同步服务器监视文件上传目录到D：</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@node3 backup]# cat /usr/local/sersync/conf/confxml.xml</span><br><span class="line"><span class="tag">&lt;<span class="title">sersync</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">localpath</span> <span class="attribute">watch</span>=<span class="value">"/backup"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">remote</span> <span class="attribute">ip</span>=<span class="value">"192.168.58.164"</span> <span class="attribute">name</span>=<span class="value">"back"</span>/&gt;</span>  这个name指的是D服务rsync服务中的模块名，要对应，否则无法同步！！</span><br><span class="line"><span class="tag">&lt;/<span class="title">localpath</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">rsync</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">commonParams</span> <span class="attribute">params</span>=<span class="value">"-artuz"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">auth</span> <span class="attribute">start</span>=<span class="value">"true"</span> <span class="attribute">users</span>=<span class="value">"rsync_backup"</span> <span class="attribute">passwordfile</span>=<span class="value">"/etc/rsync.password"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">userDefinedPort</span> <span class="attribute">start</span>=<span class="value">"false"</span> <span class="attribute">port</span>=<span class="value">"874"</span>/&gt;</span><span class="comment">&lt;!-- port=874 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">timeout</span> <span class="attribute">start</span>=<span class="value">"true"</span> <span class="attribute">time</span>=<span class="value">"100"</span>/&gt;</span><span class="comment">&lt;!-- timeout=100 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">ssh</span> <span class="attribute">start</span>=<span class="value">"false"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">rsync</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">failLog</span> <span class="attribute">path</span>=<span class="value">"/tmp/rsync_fail_log.sh"</span> <span class="attribute">timeToExecute</span>=<span class="value">"60"</span>/&gt;</span><span class="comment">&lt;!--default every 60mins execute once--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">crontab</span> <span class="attribute">start</span>=<span class="value">"false"</span> <span class="attribute">schedule</span>=<span class="value">"600"</span>&gt;</span><span class="comment">&lt;!--600mins--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">crontabfilter</span> <span class="attribute">start</span>=<span class="value">"false"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">exclude</span> <span class="attribute">expression</span>=<span class="value">"*.php"</span>&gt;</span><span class="tag">&lt;/<span class="title">exclude</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">exclude</span> <span class="attribute">expression</span>=<span class="value">"info/*"</span>&gt;</span><span class="tag">&lt;/<span class="title">exclude</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">crontabfilter</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">crontab</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">plugin</span> <span class="attribute">start</span>=<span class="value">"false"</span> <span class="attribute">name</span>=<span class="value">"command"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">sersync</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>检验是否同步到D：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@node4 backup]<span class="preprocessor"># ls /server/backup/</span></span><br><span class="line"><span class="number">1.</span>py  <span class="number">2.</span>py  <span class="number">3.</span>py  <span class="number">4.</span>py  nfs.py  www-upload</span><br><span class="line">[root@node4 backup]<span class="preprocessor">#</span></span><br></pre></td></tr></table></figure></p>
<p>测试成功！！<br>另外，可以在A服务上传一个图片，此时B的WWW-UPLOAD文件夹中已同时传入（实际是挂载），然后我们再看D服务器，此时也同时同步完成，成功！！此时要注意的是，如果要修改sersync的配置文件，那么需要重新启动下服务，否则无法立即生效！！</p>
<h3 id="8_-_扫尾工作：">8 - 扫尾工作：</h3><blockquote>
<p>核对文档需求<br>将各服务添加到开机自启动：/etc/rc.local比chkconfig 更为推荐使用，这样方便检查！<br>清楚安装过程中的密码等敏感信息：history -c</p>
<blockquote>
<p>如果是关机，先关闭前端(如A)，再关闭后端B，再关闭C,D；<br>如果是开机，先开后端（如D），再开前端C,再B,A；</p>
<p>各机器的rc.local、定时任务、各类服务的配置文件，都需要进行备份，这也算是运维工作之一了！<br>======本文到此结束========</p>
</blockquote>
</blockquote>
</span>
      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/linux/" rel="tag">#linux</a>
          
            <a href="/tags/mysql/" rel="tag">#mysql</a>
          
            <a href="/tags/nfs/" rel="tag">#nfs</a>
          
            <a href="/tags/rsync/" rel="tag">#rsync</a>
          
            <a href="/tags/ssh/" rel="tag">#ssh</a>
          
        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2013/10/22/mysql存储引擎学习笔记/" rel="next" title="mysql存储引擎学习笔记">
                <i class="fa fa-chevron-left"></i> mysql存储引擎学习笔记
              </a>
            
          </div>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2013/11/11/疑行无名，疑事无功/" rel="prev" title="疑行无名，疑事无功[网摘]">
                疑行无名，疑事无功[网摘] <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


        </div>

        


        
  <div class="comments" id="comments">
    
  </div>


      </div>

      
        
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目錄
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            本站概覽
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" src="/images/default_avatar.jpg" alt="IF" itemprop="image"/>
          <p class="site-author-name" itemprop="name">IF</p>
        </div>
        <p class="site-description motion-element" itemprop="description"></p>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">23</span>
              <span class="site-state-item-name">文章</span>
            </a>
          </div>

          <div class="site-state-item site-state-categories">
            
              <span class="site-state-item-count">1</span>
              <span class="site-state-item-name">分類</span>
              
          </div>

          <div class="site-state-item site-state-tags">
            <a href="/tags">
              <span class="site-state-item-count">33</span>
              <span class="site-state-item-name">標籤</span>
              </a>
          </div>

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        <div class="links-of-author motion-element">
          
        </div>

      </section>

      
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc-indicator-top post-toc-indicator">
            <i class="fa fa-angle-double-up"></i>
          </div>
          <div class="post-toc">
            
              
            
            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#文章结构，如下："><span class="nav-number">1.</span> <span class="nav-text">文章结构，如下：</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#总体架构图"><span class="nav-number"></span> <span class="nav-text">总体架构图</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#数据流说明"><span class="nav-number"></span> <span class="nav-text">数据流说明</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#生产环境搭建需求"><span class="nav-number"></span> <span class="nav-text">生产环境搭建需求</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#软件需求"><span class="nav-number">1.</span> <span class="nav-text">软件需求</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#请思考本次架构中的优缺点"><span class="nav-number"></span> <span class="nav-text">请思考本次架构中的优缺点</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#详细搭建过程"><span class="nav-number"></span> <span class="nav-text">详细搭建过程</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1_-_initial_os系统初始化脚本"><span class="nav-number">1.</span> <span class="nav-text">1 - initial os系统初始化脚本</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2_-_D服务器配置："><span class="nav-number">2.</span> <span class="nav-text">2 - D服务器配置：</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#创建同步目录："><span class="nav-number">2.1.</span> <span class="nav-text">创建同步目录：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#配置密码文件："><span class="nav-number">2.2.</span> <span class="nav-text">配置密码文件：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#rsyncd-conf文件快速配置文件："><span class="nav-number">2.3.</span> <span class="nav-text">rsyncd.conf文件快速配置文件：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#配置密码文件并赋文件权限："><span class="nav-number">2.4.</span> <span class="nav-text">配置密码文件并赋文件权限：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#以daemon方式运行："><span class="nav-number">2.5.</span> <span class="nav-text">以daemon方式运行：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#客户端配置："><span class="nav-number">2.6.</span> <span class="nav-text">客户端配置：</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3_-_C服务器SSHKEY分发服务："><span class="nav-number">3.</span> <span class="nav-text">3 - C服务器SSHKEY分发服务：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4_-_B服务器数据库配置："><span class="nav-number">4.</span> <span class="nav-text">4 - B服务器数据库配置：</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#配置文件的复制："><span class="nav-number">4.1.</span> <span class="nav-text">配置文件的复制：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#安装数据库文件"><span class="nav-number">4.2.</span> <span class="nav-text">安装数据库文件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#启动数据库："><span class="nav-number">4.3.</span> <span class="nav-text">启动数据库：</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5_-_A服务器HTTP的配置"><span class="nav-number">5.</span> <span class="nav-text">5 - A服务器HTTP的配置</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#安装日志轮询工具："><span class="nav-number">5.1.</span> <span class="nav-text">安装日志轮询工具：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#配置主文件："><span class="nav-number">5.2.</span> <span class="nav-text">配置主文件：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#配置虚拟主机文件："><span class="nav-number">5.3.</span> <span class="nav-text">配置虚拟主机文件：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#检查整体配置："><span class="nav-number">5.4.</span> <span class="nav-text">检查整体配置：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#创建各个主页文件："><span class="nav-number">5.5.</span> <span class="nav-text">创建各个主页文件：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#测试"><span class="nav-number">5.6.</span> <span class="nav-text">测试</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#安装PHP："><span class="nav-number">5.7.</span> <span class="nav-text">安装PHP：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#配置apache支持php："><span class="nav-number">5.8.</span> <span class="nav-text">配置apache支持php：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#修改首页文件："><span class="nav-number">5.9.</span> <span class="nav-text">修改首页文件：</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#编译安装php扩展："><span class="nav-number">6.</span> <span class="nav-text">编译安装php扩展：</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#安装eaccelerator缓存加速模块："><span class="nav-number">6.1.</span> <span class="nav-text">安装eaccelerator缓存加速模块：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#安装imagick扩展："><span class="nav-number">6.2.</span> <span class="nav-text">安装imagick扩展：</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6_-_安装应用："><span class="nav-number">7.</span> <span class="nav-text">6 - 安装应用：</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#B服务器：数据库处理："><span class="nav-number">7.1.</span> <span class="nav-text">B服务器：数据库处理：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#A应用服务器"><span class="nav-number">7.2.</span> <span class="nav-text">A应用服务器</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#客户端host处理（或局域网DNS服务器）"><span class="nav-number">7.3.</span> <span class="nav-text">客户端host处理（或局域网DNS服务器）</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7_-_定时备份任务"><span class="nav-number">8.</span> <span class="nav-text">7 - 定时备份任务</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#A服务器备份并推送至D："><span class="nav-number">8.1.</span> <span class="nav-text">A服务器备份并推送至D：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#B数据库服务器备份至D："><span class="nav-number">8.2.</span> <span class="nav-text">B数据库服务器备份至D：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#C同步服务器监视文件上传目录到D："><span class="nav-number">8.3.</span> <span class="nav-text">C同步服务器监视文件上传目录到D：</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8_-_扫尾工作："><span class="nav-number">9.</span> <span class="nav-text">8 - 扫尾工作：</span></a></li></ol></div>
            
          </div>
          <div class="post-toc-indicator-bottom post-toc-indicator">
            <i class="fa fa-angle-double-down"></i>
          </div>
        </section>
      

    </div>
  </aside>


      
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2015</span>
  <span class="with-love">
    <i class="icon-next-heart fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">IF</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="http://hexo.io">Hexo</a> 強力驅動
</div>

<div class="theme-info">
  主題 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT
  </a>
</div>



      </div>
    </footer>

    <div class="back-to-top"></div>
  </div>

  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  

  
    
    

  


  

  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js"></script>
  <script type="text/javascript" src="/js/fancy-box.js?v=0.4.5.2"></script>


  <script type="text/javascript" src="/js/helpers.js?v=0.4.5.2"></script>
  <script type="text/javascript" src="/vendors/velocity/velocity.min.js"></script>
<script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js"></script>

<script type="text/javascript" src="/js/motion.js?v=0.4.5.2" id="motion.global"></script>


  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  
<script type="text/javascript" src="/js/bootstrap.scrollspy.js?v=0.4.5.2" id="bootstrap.scrollspy.custom"></script>


<script type="text/javascript" id="sidebar.toc.highlight">
  $(document).ready(function () {
    var tocSelector = '.post-toc';
    var $tocSelector = $(tocSelector);
    var activeCurrentSelector = '.active-current';

    $tocSelector
      .on('activate.bs.scrollspy', function () {
        var $currentActiveElement = $(tocSelector + ' .active').last();

        removeCurrentActiveClass();
        $currentActiveElement.addClass('active-current');

        $tocSelector[0].scrollTop = $currentActiveElement.position().top;
      })
      .on('clear.bs.scrollspy', function () {
        removeCurrentActiveClass();
      });

    function removeCurrentActiveClass () {
      $(tocSelector + ' ' + activeCurrentSelector)
        .removeClass(activeCurrentSelector.substring(1));
    }

    function processTOC () {
      getTOCMaxHeight();
      toggleTOCOverflowIndicators();
    }

    function getTOCMaxHeight () {
      var height = $('.sidebar').height() -
                   $tocSelector.position().top -
                   $('.post-toc-indicator-bottom').height();

      $tocSelector.css('height', height);

      return height;
    }

    function toggleTOCOverflowIndicators () {
      tocOverflowIndicator(
        '.post-toc-indicator-top',
        $tocSelector.scrollTop() > 0 ? 'show' : 'hide'
      );

      tocOverflowIndicator(
        '.post-toc-indicator-bottom',
        $tocSelector.scrollTop() >= $tocSelector.find('ol').height() - $tocSelector.height() ? 'hide' : 'show'
      )
    }

    $(document).on('sidebar.motion.complete', function () {
      processTOC();
    });

    $('body').scrollspy({ target: tocSelector });
    $(window).on('resize', function () {
      if ( $('.sidebar').hasClass('sidebar-active') ) {
        processTOC();
      }
    });

    onScroll($tocSelector);

    function onScroll (element) {
      element.on('mousewheel DOMMouseScroll', function (event) {
          var oe = event.originalEvent;
          var delta = oe.wheelDelta || -oe.detail;

          this.scrollTop += ( delta < 0 ? 1 : -1 ) * 30;
          event.preventDefault();

          toggleTOCOverflowIndicators();
      });
    }

    function tocOverflowIndicator (indicator, action) {
      var $indicator = $(indicator);
      var opacity = action === 'show' ? 1 : 0;
      $indicator.velocity ?
        $indicator.velocity('stop').velocity({
          opacity: opacity
        }, { duration: 100 }) :
        $indicator.stop().animate({
          opacity: opacity
        }, 100);
    }

  });
</script>

<script type="text/javascript" id="sidebar.nav">
  $(document).ready(function () {
    var html = $('html');
    var TAB_ANIMATE_DURATION = 200;
    var hasVelocity = $.isFunction(html.velocity);

    $('.sidebar-nav li').on('click', function () {
      var item = $(this);
      var activeTabClassName = 'sidebar-nav-active';
      var activePanelClassName = 'sidebar-panel-active';
      if (item.hasClass(activeTabClassName)) {
        return;
      }

      var currentTarget = $('.' + activePanelClassName);
      var target = $('.' + item.data('target'));

      hasVelocity ?
        currentTarget.velocity('transition.slideUpOut', TAB_ANIMATE_DURATION, function () {
          target
            .velocity('stop')
            .velocity('transition.slideDownIn', TAB_ANIMATE_DURATION)
            .addClass(activePanelClassName);
        }) :
        currentTarget.animate({ opacity: 0 }, TAB_ANIMATE_DURATION, function () {
          currentTarget.hide();
          target
            .stop()
            .css({'opacity': 0, 'display': 'block'})
            .animate({ opacity: 1 }, TAB_ANIMATE_DURATION, function () {
              currentTarget.removeClass(activePanelClassName);
              target.addClass(activePanelClassName);
            });
        });

      item.siblings().removeClass(activeTabClassName);
      item.addClass(activeTabClassName);
    });

    $('.post-toc a').on('click', function (e) {
      e.preventDefault();
      var targetSelector = escapeSelector(this.getAttribute('href'));
      var offset = $(targetSelector).offset().top;
      hasVelocity ?
        html.velocity('stop').velocity('scroll', {
          offset: offset  + 'px',
          mobileHA: false
        }) :
        $('html, body').stop().animate({
          scrollTop: offset
        }, 500);
    });

    // Expand sidebar on post detail page by default, when post has a toc.
    motionMiddleWares.sidebar = function () {
      var $tocContent = $('.post-toc-content');
      if (CONFIG.sidebar === 'post') {
        if ($tocContent.length > 0 && $tocContent.html().trim().length > 0) {
          displaySidebar();
        }
      }
    };
  });
</script>



  <script type="text/javascript" src="/js/bootstrap.js"></script>

  
  

  
  

</body>
</html>
